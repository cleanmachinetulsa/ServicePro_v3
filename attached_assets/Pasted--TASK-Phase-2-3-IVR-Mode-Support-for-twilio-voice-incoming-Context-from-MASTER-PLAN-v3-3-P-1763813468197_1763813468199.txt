üöÄ TASK: Phase 2.3 ‚Äì IVR Mode Support for /twilio/voice/incoming

Context (from MASTER_PLAN v3.3 ‚Äì Phase 2):

We already have a canonical voice endpoint: POST /twilio/voice/incoming.

We already have a multi-tenant phone config table: tenant_phone_config with:

tenantId

phoneNumber

sipDomain

sipUsername

ivrMode ('simple' | 'ivr' | 'ai-voice')

Phase 2.1 + 2.2 are done and production-ready:

Calls resolve tenant by phone_number via tenantPhoneConfig.

Default behavior (ivrMode = 'simple') is direct SIP forwarding to:

jody@cleanmachinetulsa.sip.twilio.com for the root tenant.

Root tenant (id = 'root') is configured with:

phoneNumber = +19188565304

sipDomain = cleanmachinetulsa.sip.twilio.com

sipUsername = jody

ivrMode = 'simple' (for now)

üéØ Goal for this task

Implement IVR branching in POST /twilio/voice/incoming based on ivrMode, starting with a simple IVR menu for the root tenant, but designed in a multi-tenant-safe way.

We are not touching AI-voice yet ‚Äì just simple IVR vs simple SIP forward.

üîß Behavior Requirements

Respect ivrMode from tenant_phone_config:

If ivrMode === 'simple' ‚Üí keep current behavior (direct SIP <Dial> to {sipUsername}@{sipDomain} with caller ID passthrough).

If ivrMode === 'ivr' ‚Üí present a multi-option IVR menu.

If ivrMode === 'ai-voice' ‚Üí for now, just fallback to simple (we‚Äôll wire AI voice later in Phase 4).

IVR menu (for ivrMode = 'ivr'):

For now, implement this hardcoded for the root tenant, but architected so it can be tenant-specific later:

First interaction (no Digits yet):

Play / say:

‚ÄúThanks for calling [Business Name].
Press 1 to hear a quick overview of our services and get a text with booking info.
Press 2 if you‚Äôd like to talk to a person.
Press 3 to leave a detailed voicemail and we‚Äôll text you back.
Press 7 if you‚Äôd like to hear something fun.‚Äù

Use <Gather numDigits="1"> (or input="dtmf" if needed) around the prompt.

On no input / timeout, repeat once, then route to voicemail or hang up (your call, but please pick one sane default and comment it).

Press 1 ‚Äì Services overview + SMS:

TwiML:

<Say> a short summary of services (you can hardcode a generic summary for now; we‚Äôll later inject per-tenant copy).

Optionally <Pause> then say they‚Äôll receive a text with a link.

After the call branch, trigger an SMS to the caller using the existing SMS sending infrastructure (whatever helper/service we use now), something like:

‚ÄúThanks for calling [Business Name]! Here‚Äôs our info & booking link: [URL]‚Äù

Then either:

Return to the menu, or

Say goodbye and hang up.

For now, keep logic simple and comment clearly what‚Äôs happening.

Press 2 ‚Äì Talk to a person (single-number pattern):

No second number needed for now.

Behavior:

<Dial callerId="{From}"> <Sip>{sipUsername}@{sipDomain}</Sip> </Dial>

i.e., same SIP endpoint as simple mode.

If the SIP call fails/busy, play a brief apology and optionally drop them into the voicemail branch (reuse code if easy).

Press 3 ‚Äì Leave voicemail:

TwiML:

Brief instruction via <Say> (e.g., ‚ÄúPlease leave your name, vehicle, and what you‚Äôre looking to get done, and we‚Äôll text you back.‚Äù)

<Record> to capture audio.

Configure action or recordingStatusCallback to an existing or new webhook that:

Saves the voicemail metadata.

Notifies the tenant (root) ‚Äì SMS or email, whichever is currently easiest with existing code.

After recording:

<Say> a short confirmation + </Hangup>.

Press 7 ‚Äì Easter egg / fun:

Simple, light behavior:

<Say> a short, fun / kind of playful message (no profanity, no weird stuff).

Then either:

Return to main menu, or

Say goodbye and hang up.

Keep it easily replaceable later (e.g., extracted into a helper or a config block).

Other digits / invalid input:

If user presses something else:

<Say>: ‚ÄúSorry, that‚Äôs not a valid option.‚Äù

Return to the menu (once), then fallback to voicemail or hangup after repeated invalid input.

Multi-tenant-safe design

Even though we only have root right now, please design the code so:

The IVR logic can eventually read some config per tenant (e.g., tenant name, booking URL) from:

tenantConfig (business name, etc.), and/or

A future tenant_ivr_config table.

For now, you can hardcode the root tenant‚Äôs business name and booking link, but:

Put them behind helpers or constants with clear TODOs so we can later switch to DB-driven IVR per tenant.

Do NOT break existing behavior

If a tenant‚Äôs ivrMode is null/undefined/anything unexpected, fallback to simple.

If tenant_phone_config lookup fails, keep the existing fallback to root SIP (as Phase 2.2 currently does).

‚úÖ Implementation Checklist (What I want you to do)

Update canonical voice route

File: server/routes.twilioVoiceCanonical.ts

Add branching on phoneConfig.ivrMode:

'simple' ‚Üí existing SIP forward (unchanged).

'ivr' ‚Üí new IVR flow as described.

'ai-voice' ‚Üí temporary fallback to 'simple' with clear TODO comment.

Use a small helper for IVR logic

Either:

Implement IVR logic inline but organized, or

Extract to a helper like buildIvrResponse(config, reqBody) so we can later plug in per-tenant copy.

Comment clearly where we will later inject:

Tenant business name.

Booking URL.

Custom messaging per tenant.

Integrate SMS + voicemail behavior using existing infra

For Press 1:

Call our existing SMS send helper/service in Node (whatever we use now to send outbound messages) to text the caller.

For Press 3:

Wire recording callbacks into either:

An existing voicemail/recording handler route, or

A small new route that at least logs + notifies via SMS or email for now.

Keep code minimal but real ‚Äì no dummy no-op stubs. It‚Äôs okay if notifications are simple.

Add / extend tests

File: server/tests/twilioVoiceCanonical.test.ts

Add tests for:

ivrMode = 'ivr' ‚Üí returns TwiML with <Gather> and expected menu text.

Press 1 (Digits=1) ‚Üí returns TwiML with a message about services.

Press 2 (Digits=2) ‚Üí returns TwiML with <Dial> and <Sip> using the same SIP config as simple mode.

Press 3 (Digits=3) ‚Üí returns TwiML with <Record> (voicemail behavior).

Press 7 (Digits=7) ‚Üí returns TwiML with some ‚Äúfun‚Äù <Say>.

Unknown ivrMode ‚Üí falls back to simple SIP forward.

You can mock SMS/voicemail side effects where needed; we mainly need to validate TwiML structure and branching.

Keep logs helpful but not noisy

Example:

[CANONICAL VOICE] tenant=root, ivrMode=ivr, action=menu

[CANONICAL VOICE] tenant=root, ivrMode=ivr, selection=2 (forward to SIP)

üß™ Acceptance Criteria (for me to consider Phase 2.3 ‚ÄúDONE‚Äù)

 For root tenant, with ivrMode = 'ivr' set in tenant_phone_config, calling the number:

Plays the IVR menu.

Press 1 ‚Üí plays services overview + sends me an SMS.

Press 2 ‚Üí calls my SIP endpoint with caller ID preserved.

Press 3 ‚Üí records a voicemail and triggers a basic notification.

Press 7 ‚Üí plays a ‚Äúfun‚Äù message.

 For tenants with ivrMode = 'simple' (or unset), behavior is unchanged (direct SIP).

 Tests for IVR mode all pass.

 No breaking changes to existing canonical voice behavior or Telephony spine.

Use this entire message as instructions and implement Phase 2.3 accordingly.