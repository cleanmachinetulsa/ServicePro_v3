You are upgrading the ServicePro v3 base app. Implement **A2P campaign auto-submission + phone onboarding** so that a tenant can:

1) Use the A2P Campaign Assistant to submit their campaign directly to Twilio TrustHub.
2) See live campaign status, rejection reasons, and resubmit with one click.
3) Complete Step 2 of the setup wizard (“Phone & SMS Setup”) with a clear, working flow that links their account to an SMS-capable phone number and messaging service.

You MUST:
- Read existing A2P + phone-related code before editing.
- Respect multi-tenant isolation everywhere.
- Follow the existing style for services, routes, and React components.
- Add thorough comments for anything non-trivial.

────────────────────────────────────────
0. DISCOVERY – READ EXISTING IMPLEMENTATIONS
────────────────────────────────────────

First, scan these areas and summarize to yourself before touching anything:

Backend:
- server/** for:
  - a2p / sms compliance: search for “A2P”, “a2p”, “sms compliance”, “Campaign Assistant”.
  - Twilio integration: search for “twilioClient”, “twilio”, “voice/incoming”, “sms/inbound”.
  - business settings + tenants: search for “business_settings”, “tenant_config”, “tenantSettings”, “phone_config”.

Frontend:
- client/src/pages/settings/ or similar for the A2P Campaign Assistant page (likely /settings/a2p).
- client/src/pages/SetupWizard* or /setup-wizard for the stepper.
- client/src/components/phone/ or /messages/ for any phone/SMS configuration UIs already present.

DO NOT GUESS NAMES blindly – use search and follow the existing patterns.

Once you understand the existing A2P assistant (draft creation, statuses, etc.), proceed.

────────────────────────────────────────
1. DATA MODEL: EXTEND A2P CAMPAIGNS FOR TRUSTHUB
────────────────────────────────────────

Goal: existing A2P campaign drafts can now be **submitted** and tracked against Twilio TrustHub.

1.1. Locate the A2P campaign table/model (e.g., `a2p_campaigns`, `sms_campaigns`, or similar).

Add **at least** these fields (names can be adjusted to match conventions):

- twilio_brand_sid: string | null
- twilio_campaign_sid: string | null
- trusthub_status: string | null            // e.g., "draft", "submitted", "approved", "rejected", "suspended"
- trusthub_last_checked_at: Date | null
- trusthub_last_error: text | null          // store last rejection or error message
- submitted_at: Date | null
- approved_at: Date | null
- rejected_at: Date | null

Make sure:
- All new fields are tenant-scoped in queries (always filter by tenantId).
- Existing records get safe defaults (NULL / “draft”).
- Migrations are added if you use a migration system.

1.2. If there is already a status field (e.g. `status` enum like `DRAFT`, `READY_TO_SUBMIT`, `SUBMITTED`, `APPROVED`, `REJECTED`), keep using it and only add the new TrustHub-specific columns.

────────────────────────────────────────
2. TWILIO TRUSTHUB SERVICE LAYER
────────────────────────────────────────

Create or extend a dedicated service module, e.g.:

- server/services/a2pTrustHubService.ts

This module should:

2.1. Use the existing Twilio client config.

- Locate where Twilio is configured (Account SID, Auth Token, etc.), usually something like `server/lib/twilioClient.ts`.
- Reuse that client; do NOT create ad-hoc fetches.

2.2. Implement functions (pseudo-signatures, adapt to your stack):

- `ensureBrandForTenant(tenantId): Promise<{ brandSid: string }>`
  - Look up if this tenant already has a stored `twilio_brand_sid` somewhere (business_settings or a2p table).
  - If not, create a brand in TrustHub using available tenant/business data (legal business name, EIN if present, address fields, etc.).
  - Store the brand SID either in business settings or a2p table (pick the most consistent existing location).
  - Use Twilio TrustHub APIs per official docs for brand creation; handle API errors gracefully and bubble them up.

- `submitOrUpdateCampaign(tenantId, campaignId): Promise<{ campaignSid: string; status: string }>`
  - Load the tenant + A2P campaign draft.
  - Call `ensureBrandForTenant()` to get brand SID.
  - Map the campaign draft fields (use case, description, sample messages, opt-out language, etc.) into Twilio’s campaign creation API.
  - If `twilio_campaign_sid` already exists, try updating instead of re-creating, if the API supports it; otherwise, just re-use and skip creation.
  - Update the DB record with:
      - twilio_campaign_sid
      - trusthub_status
      - submitted_at (if first submission)
      - trusthub_last_error = NULL on success
  - On error, DO NOT throw an unhandled exception; record:
      - trusthub_last_error
      - trusthub_status = "error"
    and then throw a controlled error for the caller.

- `refreshCampaignStatus(tenantId, campaignId): Promise<{ status: string; rejectionReason?: string }>`
  - If no twilio_campaign_sid exists, return an error.
  - Call Twilio to fetch the current status for that campaign.
  - Update:
      - trusthub_status
      - trusthub_last_checked_at
      - approved_at / rejected_at as appropriate
      - trusthub_last_error (rejection reason or last error)
  - Return a summarized status object.

2.3. Logging & safety:

- Use existing logging utilities.
- Catch and wrap Twilio errors with clear messages for the front end.
- Ensure every Twilio call is constrained by the tenant’s context.

────────────────────────────────────────
3. API ROUTES – SUBMIT, REFRESH, RESUBMIT
────────────────────────────────────────

Create / extend routes in the admin/settings API (where A2P endpoints live). You can put them in a file like:

- server/routes/admin/a2pRoutes.ts
- or wherever the current `/settings/a2p` API endpoints are.

Add endpoints (adjust URL structure to match existing conventions):

1) `POST /api/admin/a2p/campaigns/:id/submit`
   - Auth: admin/owner of that tenant only.
   - Body: none (or optional override fields such as `force`).
   - Logic:
       - Ensure campaign belongs to the current tenant.
       - Check that campaign status is READY_TO_SUBMIT (or similar).
       - Call `submitOrUpdateCampaign`.
       - Return the updated campaign record.

2) `POST /api/admin/a2p/campaigns/:id/refresh-status`
   - Auth: admin/owner.
   - Logic:
       - Call `refreshCampaignStatus`.
       - Return updated fields needed by the UI.

3) `POST /api/admin/a2p/campaigns/:id/resubmit`
   - Auth: admin/owner.
   - Logic:
       - Only allowed if last status was REJECTED or ERROR.
       - Re-run `submitOrUpdateCampaign`.
       - Record a new submission attempt (if you have a history table, append to it).

Add proper error responses with JSON:

- { error: '...', code: 'A2P_TWILIO_ERROR' } etc.

────────────────────────────────────────
4. FRONTEND – A2P SETTINGS PAGE UPGRADE
────────────────────────────────────────

Locate the A2P Campaign Assistant page, likely:

- client/src/pages/settings/A2PSettingsPage.tsx
- or similar under client/src/pages/Settings*/.

Enhance the UI to support:

4.1. Status pill + TrustHub info

- For the currently selected campaign, show:
    - Status chip: Draft, Ready, Submitted, Approved, Rejected, Error.
    - If rejected or error: show the most recent `trusthub_last_error` in a collapsible “Details” area.
    - Show timestamps: `submitted_at`, `approved_at`, `rejected_at`, `trusthub_last_checked_at` in a small metadata panel.

4.2. Action buttons

Add buttons (respecting existing design system):

- “Submit to Twilio”:
    - Enabled only if status is READY_TO_SUBMIT.
    - Calls `POST /api/admin/a2p/campaigns/:id/submit`.
    - Shows loading state and toast on success/failure.
- “Refresh Status”:
    - Enabled if status is SUBMITTED, APPROVED, or REJECTED.
    - Calls `POST /api/admin/a2p/campaigns/:id/refresh-status`.
- “Resubmit with Fixes”:
    - Enabled if status is REJECTED or ERROR.
    - When clicked:
        - Option A (simple): Just call resubmit endpoint.
        - Option B (better): Open a small modal:
            - Summarize Twilio rejection reason.
            - Offer a button to “Let AI rewrite copy to address this reason”.
            - On confirm, update the draft content fields before resubmitting.
    - For now, implement Option A (simple) but structure the code so Option B is easy to add later.

4.3. Loading / error UX

- Whenever an action is in progress, disable buttons and show inline spinner.
- Use existing toast system to show:
    - “Campaign submitted to Twilio. Status: [status]”
    - “Status refreshed. Current state: [status]”
    - “Resubmission failed: [error message]”

Make sure the component re-fetches the campaign payload after each mutation so state stays consistent.

────────────────────────────────────────
5. SETUP WIZARD – PHONE & SMS STEP
────────────────────────────────────────

Goal: Step 2 of `/setup-wizard` should actually reflect and drive phone/SMS readiness.

5.1. Locate the setup wizard implementation:

- client/src/pages/SetupWizard.tsx (or similar).
- Identify the stepper component and the Step 2 screen.

5.2. Add real phone/SMS status indicators

Use existing APIs to detect:

- Whether the tenant has a `phone_config` entry.
- Whether there is a primary Twilio phone number assigned.
- Whether a Messaging Service is linked to that number.
- Whether an A2P campaign exists and its current status.

Create a small typed “wizard bootstrap” endpoint if needed, e.g.:

- `GET /api/admin/setup-wizard/status` (tenant scoped)
- Returns:
    - hasPhoneNumber: boolean
    - phoneNumber: string | null
    - hasMessagingService: boolean
    - messagingServiceSid: string | null
    - a2pStatus: string | null
    - missingPieces: string[]  // e.g., ['PHONE_NUMBER', 'A2P_APPROVAL']

Drive the Step 2 UI from this response.

5.3. Step 2 UI structure

Update Step 2 to show 3 stacked cards:

1) “Business Line & SMS Number”
   - Show current primary phone number if configured.
   - If not configured:
        - Show a clear message: “Your number is currently managed by the platform owner. Contact support to provision a line.” OR,
        - If there is already infrastructure for auto-provisioning: offer a button:
            - “Request Auto-Provisioned Number” → call an admin endpoint to create and assign a number.
   - For now, **prefer to represent reality**:
        - If the platform uses YOUR Twilio account only, say: “Phone provisioning is currently managed for you. We’ll notify you once your line is ready.”

2) “Inbound Routing & IVR”
   - Show whether inbound calls are routed to:
        - IVR menu (from ivr_menus).
        - Voicemail.
        - Direct forward.
   - Provide a “Go to IVR Config” button that links to `/admin/ivr-config`.

3) “A2P Registration Status”
   - Surface the same A2P trusthub_status as in Settings → A2P.
   - Show copy like:
        - Draft → “Fill out your campaign info on the A2P page.”
        - Ready_to_submit → “Looks good! Submit now from the A2P page to unlock high-volume SMS.”
        - Submitted → “Your campaign is under review. Most approvals take 1–3 business days.”
        - Approved → “✅ You’re fully registered for A2P 10DLC.”
        - Rejected/Error → Show last error + link to A2P page.

5.4. Wizard step completion logic

- The wizard already tracks per-step completion. Extend Step 2 completion rule to something like:

    - If phone + messaging + A2P approved → mark step as COMPLETE.
    - Otherwise, allow them to continue but show “Partially configured” status.

Update the backend wizard status endpoint to include Step 2’s derived completion state.

────────────────────────────────────────
6. TESTING – E2E FLOW
────────────────────────────────────────

Implement or update tests (unit or integration) for:

- A2P submission endpoint:
    - Successful submission updates Twilio SIDs + status fields.
    - Failed submission records `trusthub_last_error` and sets status to ERROR.
- Status refresh endpoint:
    - Calls the Twilio client with the expected campaign SID.
    - Updates trusthub_status and timestamps.
- Frontend A2P page:
    - Buttons enable/disable according to status.
    - Click “Submit” → calls correct endpoint and updates UI.
- Setup Wizard:
    - Fetches wizard status.
    - Renders correct hints for each combination of `hasPhoneNumber`, `hasMessagingService`, and `a2pStatus`.

If you cannot hit Twilio APIs in the test environment, isolate Twilio calls behind a small adapter that can be mocked.

────────────────────────────────────────
7. QUALITY + SAFETY
────────────────────────────────────────

- Do NOT change existing behavior for Clean Machine root tenant’s live phone number or messaging service.
- All new features must be backwards compatible; if a tenant never touches A2P, nothing breaks.
- Keep all strings user-friendly – this is a **premium app**; avoid raw error dumps in the UI.
- Add clear comments around any Twilio-specific magic values or mappings so future devs (and the owner) can maintain them.

When finished, re-run the app and manually verify:

1) Settings → A2P:
   - Draft → Ready → Submit → Refresh (status updates).
2) Setup Wizard Step 2:
   - Shows current phone/A2P status for Clean Machine.
3) No runtime errors in server logs.
