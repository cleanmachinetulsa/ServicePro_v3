You are updating my Servicepro-v3-base backend to fix the Twilio "application error" on the IVR.

Root cause: the current /handle-key route uses a <Message> verb in Voice TwiML
(vr.message(...)), which is not valid in a Voice response and causes an application error.

Fix this by:
- Removing the <Message> verb from the Voice TwiML
- Sending the SMS via the Twilio REST API instead
- Keeping the IVR menu logic (press 1 / 2 / 3) and voicemail recording
- Using only valid Voice verbs: <Say>, <Gather>, <Record>, <Hangup>, <Redirect>

Replace the entire contents of server/routes/twilioTestVoice.ts with:

import { Router } from "express";
import { twiml as TwiML } from "twilio";
import { twilioClient, TWILIO_TEST_SMS_NUMBER } from "../twilioClient";

export const twilioTestVoiceRouter = Router();

// Inbound call → IVR menu
twilioTestVoiceRouter.post("/inbound", (req, res) => {
  const vr = new TwiML.VoiceResponse();

  try {
    const gather = vr.gather({
      input: "dtmf",
      numDigits: 1,
      action: "/api/twilio/voice/handle-key",
      method: "POST",
      timeout: 6,
    });

    gather.say(
      {
        voice: "alice",
        language: "en-US",
      },
      "Thanks for calling Clean Machine Auto Detail, powered by Service Pro. " +
        "Press 1 for basic business information. " +
        "Press 2 to receive a text message link to our online booking. " +
        "Press 3 to leave a voicemail for our team."
    );

    // If no key pressed, redirect back to the menu
    vr.redirect("/api/twilio/voice/inbound");

    res.type("text/xml").send(vr.toString());
  } catch (err) {
    console.error("[TWILIO TEST VOICE ERROR - INBOUND]", err);
    const errorTwiml = new TwiML.VoiceResponse();
    errorTwiml.say(
      { voice: "alice", language: "en-US" },
      "Sorry, something went wrong on our end. Please try again later."
    );
    res.type("text/xml").send(errorTwiml.toString());
  }
});

// Menu selection handler
twilioTestVoiceRouter.post("/handle-key", async (req, res) => {
  const { Digits, From } = req.body || {};
  const vr = new TwiML.VoiceResponse();

  console.log("[TWILIO TEST VOICE - KEY]", { Digits, From });

  try {
    switch (Digits) {
      case "1":
        vr.say(
          { voice: "alice", language: "en-US" },
          "Clean Machine Auto Detail is Tulsa's highest rated mobile detailing company. " +
            "You can book online 24 7 or text this number at any time for instant scheduling."
        );
        vr.hangup();
        break;

      case "2":
        // Send SMS via REST API (not Voice TwiML)
        if (TWILIO_TEST_SMS_NUMBER && From) {
          try {
            await twilioClient.messages.create({
              from: TWILIO_TEST_SMS_NUMBER,
              to: From,
              body:
                "Here’s your Clean Machine booking link: https://cleanmachinetulsa.com. " +
                "You can text this number any time to ask questions or book.",
            });
            console.log("[TWILIO TEST VOICE] Sent follow-up SMS to", From);
          } catch (smsErr) {
            console.error("[TWILIO TEST VOICE] Error sending SMS", smsErr);
          }
        }

        vr.say(
          { voice: "alice", language: "en-US" },
          "Perfect. We've sent a text message to your phone with a booking link. Goodbye."
        );
        vr.hangup();
        break;

      case "3":
        // Voicemail recording
        vr.say(
          { voice: "alice", language: "en-US" },
          "Please leave your name, number, and a brief description of your vehicle and what you need. " +
            "Press any key when you are finished."
        );
        vr.record({
          playBeep: true,
          maxLength: 120,
          action: "/api/twilio/voice/voicemail-complete",
          method: "POST",
          finishOnKey: "1234567890*#".charAt(0), // any key stops recording; Twilio requires a single character here
        });
        break;

      default:
        vr.say(
          { voice: "alice", language: "en-US" },
          "Sorry, I didn't understand that choice."
        );
        vr.redirect("/api/twilio/voice/inbound");
        break;
    }
  } catch (err) {
    console.error("[TWILIO TEST VOICE ERROR - HANDLE KEY]", err);
    vr.say(
      { voice: "alice", language: "en-US" },
      "Sorry, something went wrong while handling your choice. Goodbye."
    );
    vr.hangup();
  }

  res.type("text/xml").send(vr.toString());
});

// Voicemail completion
twilioTestVoiceRouter.post("/voicemail-complete", (req, res) => {
  const { RecordingUrl, RecordingDuration, From } = req.body || {};

  console.log("[TWILIO TEST VOICEMAIL COMPLETE]", {
    From,
    RecordingUrl,
    RecordingDuration,
  });

  const vr = new TwiML.VoiceResponse();
  vr.say(
    { voice: "alice", language: "en-US" },
    "Thank you. Your message has been received. Goodbye."
  );
  vr.hangup();

  res.type("text/xml").send(vr.toString());
});

export default twilioTestVoiceRouter;

Make sure server/routes.ts is still mounting this router as:

import twilioTestVoiceRouter from "./routes/twilioTestVoice";
app.use("/api/twilio/voice", twilioTestVoiceRouter);

After making this change:
- Restart the server.
- Call the test number.
- You should hear the IVR (press 1 / 2 / 3).
- Press 2 should send an SMS and NOT cause an application error.
- Press 3 should let you record a voicemail and log [TWILIO TEST VOICEMAIL COMPLETE] in the console.
