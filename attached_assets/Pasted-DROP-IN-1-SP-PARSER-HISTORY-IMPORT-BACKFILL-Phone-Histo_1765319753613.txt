DROP-IN 1: SP-PARSER-HISTORY-IMPORT-BACKFILL
‚ÄúPhone History Import (Parser CSV ‚Üí DB Backfill)‚Äù

üì¶ DROP-IN PROMPT FOR REPLIT ARCHITECT
SP-PARSER-HISTORY-IMPORT-BACKFILL ‚Äî IMPORT LEGACY PHONE HISTORY (CSV/ZIP) INTO TENANT DB

You are modifying the ServicePro_v3 repo.

GOAL
Implement a **Phone History Import** feature that lets an admin upload a parser export (ZIP with contacts.csv, messages.csv, calls.csv, conversations.csv, manifest.json) and backfill:

- Customers / contacts
- Conversations + messages
- Call history

‚Ä¶for a specific tenant (initially Clean Machine = root tenant) with **deduping** and full multi-tenant safety.

This should be implemented as a reusable feature, so future tenants can also use it to ‚Äúadd more history later‚Äù even after onboarding.

HIGH-LEVEL REQUIREMENTS

1) **Back-end importer service** that:
   - Accepts a ZIP with:
     - contacts.csv
     - messages.csv
     - calls.csv
     - conversations.csv
     - manifest.json
   - Parses CSVs & manifest
   - Maps them into existing tables:
     - customers/contacts
     - conversations
     - messages
     - call logs
   - De-duplicates based on existing records (phone, email, etc.)
   - Supports:
     - **Dry run** ‚Üí compute what would happen, but don‚Äôt write
     - **Real import** ‚Üí write rows, return stats

2) **Tracking table** (import batches) so we can see what was imported and when.

3) **Admin UI page** where the tenant owner/admin can:
   - Upload the ZIP
   - Run a dry run
   - Run the actual import
   - See summary stats and previous batches

4) Everything must be **tenant-aware** and use the existing multi-tenant plumbing (wrapTenantDb or equivalent).

-----------------------------------
STEP 1 ‚Äì DISCOVER EXISTING SCHEMA
-----------------------------------

First, inspect the current schema and code to find the right tables. Do NOT create duplicate entities if they already exist.

1. Open shared schema:

- `shared/schema.ts`
- Find tables related to:
  - customers / contacts
  - conversations / threads
  - messages
  - calls / call logs
  - any existing import/history tables

2. Use ripgrep to find references:

- Search for customers:
  - `rg -n "customers" shared server client`
- Search for conversations:
  - `rg -n "conversations" shared server client`
- Search for messages:
  - `rg -n "conversation_messages|messages" shared server client`
- Search for call logs:
  - `rg -n "call_log|call_logs|calls" shared server client`

3. Identify:

- The **canonical customer table** (e.g. `customers` or `tenant_customers`)
- The **canonical conversation and message tables** used by the Messages UI
- The **canonical call log table** used by call history UI
- Any existing `phone_history_imports` / parser-related tables (if they exist)

We will re-use those, not create new top-level tables.

-----------------------------------
STEP 2 ‚Äì ADD IMPORT BATCH TABLE
-----------------------------------

Add a table in `shared/schema.ts` to track import batches:

- Table name: `phone_history_import_batches`

Fields:

- `id` (serial PK)
- `tenant_id` (FK ‚Üí tenants.id, NOT NULL)
- `source` TEXT NOT NULL DEFAULT 'parser-csv'
  - e.g. 'parser-csv', 'twilio-export', etc.
- `created_at` TIMESTAMP NOT NULL DEFAULT NOW()
- `created_by_user_id` TEXT NULL
- `dry_run` BOOLEAN NOT NULL DEFAULT FALSE
- `summary_json` JSONB NOT NULL DEFAULT '{}'::jsonb
  - counts: contacts_new/updated, conversations_new, messages_new, calls_new, etc.
- `notes` TEXT NULL

Apply the schema change using the existing pattern (db:push or raw ALTER TABLE as appropriate).

-----------------------------------
STEP 3 ‚Äì IMPORTER SERVICE
-----------------------------------

Create a service module that will parse and import the uploaded archive.

New file example:

- `server/services/phoneHistoryImportService.ts`

Responsibilities:

1) **Parsing the archive**

- Accept:
  - `tenantId: string`
  - `buffer: Buffer` (ZIP file contents)

- Use a ZIP library available in the project (if none, add a dependency that works in this environment, e.g. `adm-zip` or `jszip`).
- Extract the following files (case-insensitive, but ideally exact):
  - `contacts.csv`
  - `messages.csv`
  - `calls.csv`
  - `conversations.csv`
  - `manifest.json`
- Parse CSVs (use an existing CSV helper if present; otherwise, use a well-supported CSV parser dependency that‚Äôs already used in the repo).
- Parse `manifest.json` for counts.

Return a normalized structure, e.g.:

```ts
export interface ParsedPhoneHistory {
  manifest: {
    contactsCount: number;
    messagesCount: number;
    callsCount: number;
    conversationsCount: number;
    raw: any;
  };
  contacts: ParsedContactRow[];
  conversations: ParsedConversationRow[];
  messages: ParsedMessageRow[];
  calls: ParsedCallRow[];
}
Each parsed row:
* Should have original IDs (e.g. external_contact_id, external_conversation_id) so we can link messages/conversations.‚Ä®
2. Normalization helpers‚Ä®
Create helpers for:
* normalizePhone(raw: string): string | null
    * Strip punctuation, spaces, etc.‚Ä®
    * Ensure E.164 for US: if 10 digits ‚Üí prepend +1‚Ä®
    * Return null if invalid/unusable‚Ä®
* getTwilioNumbersForTenant(tenantId):
    * Use existing config/DB where Twilio numbers are stored.‚Ä®
    * Needed to determine inbound vs outbound direction for messages/calls.‚Ä®
3. Dry Run & Real Import‚Ä®
Design two top-level functions:

export interface PhoneHistoryImportOptions {
  dryRun: boolean;
  batchNotes?: string | null;
  userId?: string | null;
}

export interface PhoneHistoryImportSummary {
  contacts: { new: number; updated: number; skipped: number };
  conversations: { new: number; skipped: number };
  messages: { new: number; skipped: number };
  calls: { new: number; skipped: number };
  manifest?: ParsedPhoneHistory['manifest'];
}

export async function importPhoneHistoryFromArchive(
  tenantId: string,
  buffer: Buffer,
  options: PhoneHistoryImportOptions
): Promise<PhoneHistoryImportSummary>
Implementation strategy:
* Use wrapTenantDb(tenantId, async (db) => {...}) pattern for all writes to ensure tenant isolation.‚Ä®
* Deduplication:
    * Contacts:
        * Identify existing customer by normalized phone and/or email.‚Ä®
        * If found ‚Üí update missing fields (e.g. name) but avoid overwriting better data.‚Ä®
        * If not found ‚Üí insert.‚Ä®
    * Conversations:
        * Use external conversation ID + tenant to avoid duplicates:
            * Either store external_conversation_id in a dedicated column, OR maintain a mapping table:
                * phone_history_conversation_links with:
                    * tenant_id‚Ä®
                    * external_conversation_id‚Ä®
                    * conversation_id‚Ä®
        * If mapping exists ‚Üí reuse conversation_id.‚Ä®
        * If not ‚Üí create a new conversation row and link it.‚Ä®
    * Messages:
        * Use conversation mapping + timestamp and body.‚Ä®
        * Optionally, avoid double-inserting if a message with same external ID and timestamp already exists.‚Ä®
    * Calls:
        * Similar pattern: map to customer by phone; dedupe if we have a primary key / external ID mapping.‚Ä®
* When options.dryRun === true:
    * Perform lookups but do not INSERT/UPDATE.‚Ä®
    * Return counts of what would be created/updated.‚Ä®
* When options.dryRun === false:
    * Actually apply INSERTs/UPDATEs.‚Ä®
    * Create a phone_history_import_batches row at the end with:
        * summary_json containing the summary object‚Ä®
        * dry_run flag‚Ä®
        * notes from batchNotes‚Ä®
        * created_by_user_id‚Ä®
Make sure you respect existing types and column names (adapt mapping as needed).

STEP 4 ‚Äì API ROUTES
Create a new routes file:
* server/routes.admin.phoneHistoryImport.ts (or similar)‚Ä®
Register it in server/index.ts with appropriate admin auth middleware.
Endpoints:
1. POST /api/admin/import/phone-history
    * Auth: tenant owner/admin only.‚Ä®
    * Accept multipart/form-data:
        * Field: file (ZIP)‚Ä®
        * Field: dryRun (boolean, default true)‚Ä®
        * Field: notes (optional string)‚Ä®
    * Determine tenantId from the auth context (for now, will be root in your env).‚Ä®
    * Read uploaded file into Buffer.‚Ä®
    * Call importPhoneHistoryFromArchive(tenantId, buffer, { dryRun, batchNotes: notes, userId }).‚Ä®
    * Return:
        * summary: PhoneHistoryImportSummary‚Ä®
        * dryRun: boolean‚Ä®
2. GET /api/admin/import/phone-history/batches
    * Returns last N batches for the current tenant:
        * id, created_at, dry_run, summary_json, notes.‚Ä®
3. (Optional but nice) GET /api/admin/import/phone-history/batch/:id
    * Returns full summary for a single batch.‚Ä®

STEP 5 ‚Äì ADMIN UI PAGE
Create a React page:
* client/src/pages/admin/PhoneHistoryImportPage.tsx‚Ä®
Requirements:
* Only visible to tenant owner/admin (respect existing RBAC).‚Ä®
* Form with:
    * File input for ZIP‚Ä®
    * Checkbox toggle for ‚ÄúDry run only (no data will be written)‚Äù ‚Äì default ON‚Ä®
    * Optional notes textarea‚Ä®
    * Submit button: ‚ÄúRun Import‚Äù‚Ä®
* After submit:
    * Call POST /api/admin/import/phone-history.‚Ä®
    * Show a loading state.‚Ä®
    * Render:
        * If dryRun:
            * ‚ÄúDry Run Summary‚Äù‚Ä®
            * show counts (contacts new/updated, conversations, messages, calls).‚Ä®
            * Prompt: ‚ÄúIf this looks correct, uncheck Dry Run and run again.‚Äù‚Ä®
        * If real import:
            * ‚ÄúImport Complete‚Äù‚Ä®
            * show final summary.‚Ä®
* Below form:
    * A small table of previous batches (from GET /api/admin/import/phone-history/batches):
        * Date‚Ä®
        * Dry run?‚Ä®
        * Source (hardcoded 'parser-csv' for now)‚Ä®
        * Key stats (e.g. contacts.new, messages.new)‚Ä®
Add navigation:
* In client/src/config/navigationItems.ts:
    * Add an owner-only admin link (under Admin or Tools):
        * id: 'phone-history-import'‚Ä®
        * label: 'Phone History Import'‚Ä®
        * path: '/admin/phone-history-import'‚Ä®
        * restricted to owner / admin roles using the existing RBAC helpers.‚Ä®

STEP 6 ‚Äì CLEAN MACHINE USAGE
After implementation, the intended usage for the root tenant (Clean Machine) is:
1. Zip your parser export files:
    * contacts.csv‚Ä®
    * messages.csv‚Ä®
    * calls.csv‚Ä®
    * conversations.csv‚Ä®
    * manifest.json‚Ä®
2. Log in as owner/admin.‚Ä®
3. Go to Admin ‚Üí Phone History Import.‚Ä®
4. Upload the ZIP, run Dry Run.‚Ä®
5. If the summary looks correct, uncheck Dry Run and run again to perform the real import.‚Ä®

STEP 7 ‚Äì TESTING
Add or update tests to verify:
* Admin can open /admin/phone-history-import and see the upload form.‚Ä®
* API:
    * Rejects missing file.‚Ä®
    * Returns summary for dryRun.‚Ä®
    * Performs writes on real import (ideally using a small fixture ZIP in tests).‚Ä®
* Data is correctly tenant-scoped:
    * Records are associated with the current tenant only.‚Ä®
* Optionally, check that imported conversations/messages show up in the existing Messages UI for that tenant.‚Ä®
Please implement all of the above with robust error handling, logging (for debugging), and minimal disruption to existing parser integration.
