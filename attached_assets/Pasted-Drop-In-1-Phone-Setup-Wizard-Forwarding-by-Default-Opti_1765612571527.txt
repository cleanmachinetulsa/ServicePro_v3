Drop-In #1 ‚Äî Phone Setup Wizard (Forwarding by Default + Optional SIP + Test Call)
Use this as-is in Replit Architect.‚Ä®Title suggestion: SP-TELEPHONY-SETUP-WIZARD

üì¶ DROP-IN PROMPT FOR REPLIT ARCHITECT
SP-TELEPHONY-SETUP-WIZARD ‚Äî PHONE DELIVERY MODES + TEST CALL

You are modifying the ServicePro_v3 repo.

GOAL
Implement a tenant-aware Phone Setup Wizard that:
- Uses **‚ÄúForward to my personal phone‚Äù as the default call delivery mode**
- Allows an **optional SIP softphone setup (Groundwire or other)** for advanced users
- Optionally supports a **‚Äúwhisper‚Äù** announcement on incoming calls
- Includes a **‚ÄúTest My Phone Setup‚Äù button** that:
  - Triggers an automated Twilio test call
  - Shows **pass/fail** in the UI with a human-readable reason
  - On failure, logs a structured support issue using the existing support_issues pipeline (SP-SUPPORT-A) so the setup/support agent can help debug

CRITICAL CONSTRAINTS
- Do NOT break existing IVR, AI, or voicemail flows.
- When the caller chooses ‚Äútalk to someone‚Äù in the current IVR, we ONLY change the **downstream dial behavior**, not the IVR itself.
- Keep it **multi-tenant safe**:
  - All settings are scoped by tenant
  - Clean Machine = root tenant, but the feature must work for non-root tenants too.

HIGH-LEVEL DESIGN

1) DATA MODEL: Tenant Telephony Settings

Create a tenant-scoped settings layer for call delivery:

- Add a new table or extend an existing tenant settings table (whichever is already in use for telephony):

  - Table name (if new): `tenant_telephony_settings`
    - `tenant_id` (FK ‚Üí tenants.id, PK or UNIQUE)
    - `call_delivery_mode` TEXT NOT NULL DEFAULT 'forward'  
      - Allowed values:
        - 'forward'          ‚Üí Forward to personal phone (DEFAULT)
        - 'forward_with_whisper' ‚Üí Forward with a whisper announcement
        - 'sip_softphone'    ‚Üí Dial SIP endpoint instead of PSTN
    - `forward_phone_number` TEXT NULL
      - E.164 string, validated on save
    - `sip_address` TEXT NULL
      - e.g. `sip:1234@sip.provider.com` or Twilio SIP URI
    - `sip_label` TEXT NULL
      - Display label: e.g. ‚ÄúGroundwire on Jody‚Äôs iPhone‚Äù
    - `last_phone_test_status` TEXT NULL
      - 'pass' | 'fail' | null
    - `last_phone_test_error` TEXT NULL
      - Human-readable error summary
    - `last_phone_test_at` TIMESTAMP NULL

If there is an existing telephony settings table you prefer, extend that instead and keep the above fields logically the same.

2) API: Settings + Test Call

Create or extend routes under something like:

- `server/routes.settings.telephony.ts`

Endpoints:

1. `GET /api/settings/telephony`
   - Auth: tenant + authenticated user
   - Returns current telephony settings for the tenant:
     - callDeliveryMode
     - forwardPhoneNumber
     - sipAddress
     - sipLabel
     - lastPhoneTestStatus
     - lastPhoneTestError
     - lastPhoneTestAt

2. `PUT /api/settings/telephony`
   - Auth: same as above
   - Validations:
     - If `call_delivery_mode` = 'forward' or 'forward_with_whisper':
       - `forward_phone_number` is required and must be valid E.164
     - If `call_delivery_mode` = 'sip_softphone':
       - `sip_address` is required and must look like a SIP URI
   - Persist to `tenant_telephony_settings` (upsert by tenant_id).

3. `POST /api/settings/telephony/test-call`
   - Auth: tenant + authenticated user (owner/admin only)
   - Behavior:
     - Inspect tenant‚Äôs current telephony settings
     - Use Twilio to place a **test outbound call** to:
       - If mode = forward / forward_with_whisper ‚Üí `forward_phone_number`
       - If mode = sip_softphone ‚Üí `sip_address`
     - Play a short TTS:  
       ‚ÄúThis is a ServicePro test call for {businessName}. Your phone integration is working.‚Äù
     - If Twilio responds successfully ‚Üí mark test as PASS
     - If Twilio returns error (bad number, invalid SIP, etc.) ‚Üí mark as FAIL
   - Persist:
     - `last_phone_test_status`, `last_phone_test_error`, `last_phone_test_at`
   - On FAIL:
     - Create a record in `support_issues`:
       - `tenant_id`
       - `issue_type` = 'telephony-setup-test-failed'
       - `severity` = 'medium'
       - `source` = 'telephony-setup-wizard'
       - `context` JSON containing:
         - call_delivery_mode
         - forward_phone_number or sip_address
         - Twilio error code/message
     - Return that context to the frontend so the setup/support assistant can explain what happened.

3) TWILIO CALL FLOW INTEGRATION

Existing behavior (KEEP):

- Caller hits IVR
- Caller presses ‚Äútalk to someone‚Äù
- System currently dials a configured number or SIP endpoint (hardcoded or legacy settings)

New behavior:

- Replace the hardcoded dial target with logic that reads `tenant_telephony_settings`:

  Pseudocode:

  ```ts
  const settings = await getTelephonySettingsForTenant(tenantId);

  switch (settings.callDeliveryMode) {
    case 'forward':
      // Standard <Dial><Number>
      dialForwardNumber(settings.forward_phone_number);
      break;
    case 'forward_with_whisper':
      // Use Twilio ‚Äúwhisper‚Äù or a short TTS before connecting
      dialForwardNumberWithWhisper(settings.forward_phone_number, businessName);
      break;
    case 'sip_softphone':
      // <Dial><Sip>
      dialSipEndpoint(settings.sip_address);
      break;
    default:
      // Safe fallback: behave as simple forward or fail gracefully
  }
* Implement helper functions in a Twilio voice service file (where you already build TwiML):
    * dialForwardNumber(phone, options?)‚Ä®
    * dialForwardNumberWithWhisper(phone, businessName)‚Ä®
    * dialSipEndpoint(sipAddress)‚Ä®
Do NOT remove existing IVR logic; only swap out the final Dial target.
4. FRONTEND: Phone Setup Wizard Step‚Ä®
Create/extend a step in the Setup Wizard and in Settings:
* New page (if not present):‚Ä®client/src/pages/settings/TelephonySetupPage.tsx‚Ä®
* Also expose it in:
    * Setup Wizard (for new tenants) ‚Äì something like ‚ÄúStep: Phone & Call Handling‚Äù‚Ä®
    * Settings ‚Üí ‚ÄúPhone & Call Routing‚Äù‚Ä®
UI Requirements:
* Section 1: Call Delivery Mode (radio buttons or segmented control)
    * ‚ÄúForward to my personal phone (recommended)‚Äù‚Ä®
    * ‚ÄúForward with a short ‚Äòbusiness call‚Äô whisper‚Äù‚Ä®
    * ‚ÄúUse SIP softphone (advanced)‚Äù‚Ä®
* Section 2: Forwarding Settings
    * Shown when mode = forward or forward_with_whisper‚Ä®
    * Input: ‚ÄúPersonal phone number‚Äù‚Ä®
    * Helper text: ‚ÄúWe‚Äôll forward business calls here. Unknown numbers will be business calls coming from your ServicePro line.‚Äù‚Ä®
* Section 3: SIP Softphone Settings (Advanced)
    * Shown when mode = sip_softphone‚Ä®
    * Inputs:
        * SIP address (e.g. sip:1234@sip.provider.com)‚Ä®
        * Label (e.g. ‚ÄúGroundwire on Owner‚Äôs iPhone‚Äù)‚Ä®
    * Helper text summarizing:
        * ‚ÄúDownload Groundwire (or another SIP app)‚Äù‚Ä®
        * ‚ÄúUse the SIP credentials we provide in the separate SIP Setup step‚Äù (this will hook into the second drop-in)‚Ä®
* Section 4: Test My Phone Setup
    * Button: ‚ÄúRun Test Call‚Äù‚Ä®
    * On click:
        * Calls POST /api/settings/telephony/test-call‚Ä®
        * Shows spinner / ‚ÄúRunning test‚Ä¶‚Äù‚Ä®
    * After response:
        * On success:
            * Show green badge: ‚Äú‚úÖ Test call succeeded‚Äù‚Ä®
            * Show timestamp‚Ä®
        * On failure:
            * Show red badge: ‚Äú‚ùå Test call failed‚Äù‚Ä®
            * Show a 1‚Äì2 sentence error summary from last_phone_test_error‚Ä®
            * Inform the user: ‚ÄúWe‚Äôve logged this issue for support and will help you fix it.‚Äù‚Ä®
            * (This ties into support_issues + setup assistant)‚Ä®
* Hook into Setup Completion:
    * If this step is part of the onboarding wizard, mark it as ‚ÄúCompleted‚Äù when:
        * call_delivery_mode is set‚Ä®
        * And either:
            * Forward phone is valid (for forward modes), or‚Ä®
            * SIP address is valid (for sip_softphone)‚Ä®
        * Test call is recommended but not strictly required to mark it complete.‚Ä®
5. TESTING‚Ä®
Add or update tests (Playwright / integration) to verify:
* Admin can open Phone Setup page‚Ä®
* Can switch between delivery modes‚Ä®
* Validation triggers on missing forward number or SIP address‚Ä®
* Test call endpoint is invoked and the result renders‚Ä®
* On simulated failure, a support_issues record is created and error is visible in UI‚Ä®
Please implement all of the above with clean TypeScript, proper tenant isolation, and minimal disruption to existing Twilio flows.
