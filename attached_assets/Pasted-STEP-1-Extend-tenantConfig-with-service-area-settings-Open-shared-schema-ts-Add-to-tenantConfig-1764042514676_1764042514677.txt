STEP 1 ‚Äî Extend tenantConfig with service-area settings

Open: shared/schema.ts

Add to tenantConfig table:

serviceAreaMaxMinutes: integer | null;     // max allowed travel time (default 25)
serviceAreaSoftDeclineMessage: text | null; // custom oversight phrasing
homeBaseLat: double precision | null;
homeBaseLng: double precision | null;
homeBaseAddress: text | null;


If needed, generate migration.

Default values (your personal defaults will be set inside builder service below):

serviceAreaMaxMinutes = 25

homeBaseLat/homeBaseLng pulled from Clean Machine‚Äôs home base address

serviceAreaSoftDeclineMessage:
"It looks like you're slightly outside our service area, but we sometimes make exceptions."

üß© STEP 2 ‚Äî Create geocoding service

Create: server/services/geocodeService.ts

// server/services/geocodeService.ts

export async function geocodeAddress(address: string): Promise<{
  lat: number | null;
  lng: number | null;
  formatted: string | null;
}> {
  try {
    const apiKey = process.env.GOOGLE_MAPS_API_KEY;
    if (!apiKey) return { lat: null, lng: null, formatted: null };

    const url = `https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(
      address
    )}&key=${apiKey}`;

    const res = await fetch(url);
    const json = await res.json();

    const result = json?.results?.[0];
    if (!result) return { lat: null, lng: null, formatted: null };

    const { lat, lng } = result.geometry.location;
    const formatted = result.formatted_address;

    return { lat, lng, formatted };
  } catch (err) {
    console.error('[GEOCODE ERROR]', err);
    return { lat: null, lng: null, formatted: null };
  }
}

üß© STEP 3 ‚Äî Create service area evaluator

Create: server/services/serviceAreaEvaluator.ts

import { wrapTenantDb } from '../tenantDb';
import { db } from '../db';
import { tenantConfig } from '@shared/schema';
import { eq } from 'drizzle-orm';
import { getTravelTimeMinutes } from './travelTimeService';

export async function evaluateServiceArea(
  tenantId: string,
  targetLat: number | null,
  targetLng: number | null
): Promise<{
  inServiceArea: boolean;
  travelMinutes: number | null;
  softDeclineMessage: string | null;
}> {
  if (!targetLat || !targetLng) {
    return { inServiceArea: true, travelMinutes: null, softDeclineMessage: null };
  }

  const tenantDb = wrapTenantDb(db, tenantId);

  const [config] = await tenantDb
    .select()
    .from(tenantConfig)
    .where(eq(tenantConfig.tenantId, tenantId))
    .limit(1);

  if (!config?.homeBaseLat || !config?.homeBaseLng) {
    // If tenant has not configured home base, treat as inside service area
    return { inServiceArea: true, travelMinutes: null, softDeclineMessage: null };
  }

  const maxMinutes = config.serviceAreaMaxMinutes ?? 25;

  const travelMinutes = await getTravelTimeMinutes(
    config.homeBaseLat,
    config.homeBaseLng,
    targetLat,
    targetLng
  );

  if (travelMinutes == null) {
    return { inServiceArea: true, travelMinutes: null, softDeclineMessage: null };
  }

  const softDeclineMessage =
    config.serviceAreaSoftDeclineMessage ??
    'It appears your location is slightly outside our service area, but we do sometimes make exceptions.';

  return {
    inServiceArea: travelMinutes <= maxMinutes,
    travelMinutes,
    softDeclineMessage,
  };
}

üß© STEP 4 ‚Äî Add address validation/geocoding + service area evaluation into bookingDraftService

Open: server/services/bookingDraftService.ts

Add imports:

import { geocodeAddress } from './geocodeService';
import { evaluateServiceArea } from './serviceAreaEvaluator';


Inside main builder:

// STEP 1: GEOCODE ADDRESS
let geo = { lat: null, lng: null, formatted: null } as any;
if (state?.address) {
  geo = await geocodeAddress(state.address);
}

// STEP 2: SERVICE AREA EVALUATION
const serviceArea = await evaluateServiceArea(
  tenantId,
  geo.lat,
  geo.lng
);

// Add into booking draft
const draft: BookingDraft = {
  ...
  address: geo.formatted ?? state?.address ?? customer?.address ?? null,
  addressLat: geo.lat,
  addressLng: geo.lng,
  inServiceArea: serviceArea.inServiceArea,
  travelMinutes: serviceArea.travelMinutes,
  serviceAreaSoftDeclineMessage: serviceArea.softDeclineMessage,
  ...
};


Add missing fields to BookingDraft:

addressLat?: number | null;
addressLng?: number | null;
inServiceArea?: boolean | null;
travelMinutes?: number | null;
serviceAreaSoftDeclineMessage?: string | null;

üß© STEP 5 ‚Äî BookingPanel UI updates

Open: client/src/components/BookingPanel.tsx

Add UI warning:

{draft?.inServiceArea === false && (
  <div className="p-3 mt-3 border rounded-md bg-red-50 text-red-800">
    <div className="font-semibold mb-1">Outside Service Area</div>
    <div>{draft.serviceAreaSoftDeclineMessage}</div>
    <div className="mt-2 text-xs opacity-70">
      Estimated travel time: {draft.travelMinutes} minutes
    </div>

    <button
      className="mt-3 px-3 py-1 bg-yellow-500 text-white rounded"
      onClick={() => setOverride(true)}
    >
      Submit Anyway (Requires Manual Approval)
    </button>
  </div>
)}


Then prevent automatic booking unless override is true:

if (!draft?.inServiceArea && !override) {
  disableSubmit = true;
}

üß© STEP 6 ‚Äî Add Clean Machine Root-Tenant Custom Logic

In bookingDraftService.ts, after serviceArea = await evaluateServiceArea:

// Special behavior for Clean Machine root-tenant
if (tenantId === 'root-cleanmachine') {
  // Hard-coded your homebase threshold override
  if (serviceArea.travelMinutes != null && serviceArea.travelMinutes > 25) {
    draft.requiresManualApproval = true;
  }
}


Add field:

requiresManualApproval?: boolean;


BookingPanel:

if (draft.requiresManualApproval && !override) {
  disableSubmit = true;
}

üß© STEP 7 ‚Äî AI Behavior V2 SMS Logic

Update AI Behavior V2 system prompt builder:

If customer address is out-of-area:

AI should send:

‚ÄúIt looks like you might be slightly outside our normal service area, but we do sometimes make exceptions. If you‚Äôd like, you can still send your request and a team member will review it manually.‚Äù

Include in system builder:

if (bookingDraft.inServiceArea === false) {
  SYSTEM_PROMPT += `
When the customer asks to book:
- Inform them they may be outside the service area.
- Never decline outright.
- Offer the 'submit anyway' option.
- Do NOT confirm the appointment.
- Use soft, friendly language exactly as follows:
"${bookingDraft.serviceAreaSoftDeclineMessage} If you'd like to submit anyway, I can forward your request for manual review."`;
}

üß© YOU NOW HAVE:

‚úì Address validation
‚úì Google geocoding
‚úì Lat/Lng storage
‚úì Travel-time calculation
‚úì Tenant-configurable max travel time
‚úì Soft decline messaging
‚úì ‚ÄúSubmit anyway‚Äù override
‚úì Manual approval flow
‚úì AI Behavior V2 aware of service area
‚úì Clean Machine root-tenant custom behavior
‚úì Multi-tenant isolation
‚úì BookingPanel UI constraints

This is EXACTLY what Clean Machine needs today
AND
what ServicePro needs globally.