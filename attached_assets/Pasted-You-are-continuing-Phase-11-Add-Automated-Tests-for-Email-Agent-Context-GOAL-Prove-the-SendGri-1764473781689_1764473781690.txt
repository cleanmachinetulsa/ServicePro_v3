You are continuing Phase 11 â€“ Add Automated Tests for Email + Agent Context

GOAL:
Prove the SendGrid v1 email plumbing is functioning correctly and that the Agent Context Engine is returning correct status flags and gaps under multiple configurations.

Create a full end-to-end Jest test suite covering:

=============================================================
TEST GROUP 1 â€“ DB + MIGRATION
=============================================================

âœ“ Assert tenant_email_profiles table exists
âœ“ Insert a tenant row + email profile row â†’ expect read to succeed
âœ“ Ensure no row is visible across tenant boundaries (multi-tenant safety)

FILES:
ðŸ†• tests/email/migration.test.ts

=============================================================
TEST GROUP 2 â€“ EMAIL SERVICE BEHAVIOR
=============================================================

ðŸ†• tests/email/emailService.test.ts

Write tests for:

1) When SENDGRID_API_KEY *is missing*
   - CALL sendTenantEmail()
   - Expect {ok:false, reason:'missing_env'}
   - Ensure NO exception is thrown
   - Ensure no DB writes occur

2) When API key is present BUT tenant email profile does not exist
   - CALL sendTenantEmail()
   - Expect graceful failure or fallback
   - Expect reply-to defaults to tenant.ownerEmail if exists

3) When full profile exists AND API key exists
   - MOCK sgMail.send to return success
   - Expect {ok:true}
   - Expect status upgraded to 'healthy'

4) Force SendGrid send error
   - MOCK sgMail.send to throw
   - Expect {ok:false, reason:'send_failed'}
   - Expect profile.status === 'error'

=============================================================
TEST GROUP 3 â€“ AGENT CONTEXT INTEGRATION
=============================================================

ðŸ†• tests/agent/context-email.test.ts

Mock environments:

CASE A â€“ No SendGrid env vars
âœ“ context.email.provider = "none"
âœ“ gaps includes email_missing_env error

CASE B â€“ SendGrid enabled but NO tenant profile
âœ“ provider="sendgrid"
âœ“ status="not_configured"
âœ“ gaps includes email_profile_missing warning

CASE C â€“ Tenant has profile + healthy status
âœ“ provider="sendgrid"
âœ“ status="healthy"
âœ“ gaps.length === 0

All tests must use wrapTenantDb to maintain isolation.

=============================================================
ADD DEV COMMANDS
=============================================================

Update package.json:

"scripts": {
  "test": "jest --runInBand",
  "test:watch": "jest --watch",
  "test:email": "jest tests/email --runInBand",
  "test:agent": "jest tests/agent --runInBand"
}

=============================================================
SUCCESS CRITERIA
=============================================================

The following must pass with no manual guessing:

âœ” jest runs with 0 failures
âœ” Agent Context returns correct email slice for every case
âœ” No cross-tenant leakage
âœ” Email service gracefully handles env failure
âœ” Errors produce proper gap messages

Return ONLY:

1) a PASS/FAIL summary
2) a sample Agent Context output JSON

This ensures we *never again hope something works* â€” we KNOW.
When you run the tests, I expect output like:
json
Copy code
{
  "email": {
    "provider": "sendgrid",
    "fromEmail": "no-reply@servicepro-mail.com",
    "fromName": "Tulsa Detailers LLC",
    "replyToEmail": "owner@tulsadetailers.com",
    "status": "healthy"
  },
  "gaps": []
}
If tests fail â€” good. We fix them until green.

If they pass â€” we move to Phase 12 with confidence.

When Replit finishes, reply with:
nginx
Copy code
PHASE 11 TEST RESULTS READY
And paste:

The test summary screenshot or output

The JSON returned by /api/agent/context

Then we execute Phase 12 instantly â€” with speed and certainty instead of luck. ðŸš€








