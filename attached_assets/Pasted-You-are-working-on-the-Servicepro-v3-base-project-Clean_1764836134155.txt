You are working on the Servicepro-v3-base project (Clean Machine / ServicePro multi-tenant comms hub).

I want you to perform a focused set of *fixes*, not a redesign. There are four main problems:

1) Twilio login popup while viewing voicemail (browser hitting api.twilio.com directly)
2) Inbound SMS often replies with: “I apologize, but I didn’t generate a proper response.”
3) Outbound calls from the app cause Twilio “we’re sorry, an application error has occurred” instead of connecting me to the customer.
4) Messages page thread column / scroll behavior is cramped and partially broken.

Please fix these in this order, with careful, minimal, well-documented changes. Preserve all existing working behavior, the IVR logic we just built, and multi-tenant safety.

--------------------------------
GLOBAL CONSTRAINTS / CONTEXT
--------------------------------

- Root tenant is Clean Machine. Do NOT break existing IVR behavior for Clean Machine.
- Phone number: MAIN_PHONE_NUMBER is the Clean Machine line.
- Inbound SMS webhook: POST /api/twilio/sms/inbound
- Voice webhooks (already configured in Twilio Console):
  - Voice incoming: POST /twilio/voice/incoming
  - Call status: POST /twilio/voice/call-status
  - IVR selection: POST /twilio/voice/ivr-selection
  - Voicemail callbacks: /twilio/voice/recording-status and /twilio/voice/voicemail-transcribed
- There is already a voicemail conversation sync service and a visual voicemail UI (Phone > Voicemail tab, and MessageBubble voicemail UI).
- Multi-tenant: keep tenant isolation exactly as-is. If you touch anything tenant-related, be explicit and safe.

When you are done, briefly summarize:
- Files changed
- Behavior before vs after (for each of the 4 items)
- Any TODOs or follow-ups that are important.

Now the specific tasks:

--------------------------------
TASK 1 – Twilio media proxy (fix login popup)
--------------------------------

Problem: When viewing voicemails on the Messages/Phone pages, the browser sometimes shows a Twilio “Sign in” HTTP Basic Auth popup. That means some client code is using a raw Twilio URL (e.g. https://api.twilio.com/2010-04-01/Accounts/.../Recordings/...) directly in an <audio> tag or link.

Goal: All Twilio media (voicemail audio, etc.) must be fetched via a backend proxy route, using server-side Twilio credentials. The browser should *never* talk directly to api.twilio.com.

Steps:

1) FIND REFERENCES
   - Search the client for any usage of:
     - "api.twilio.com"
     - "recordingUrl"
     - Twilio Recording URLs in message metadata (e.g. metadata.recordingUrl).
   - Identify which React components render voicemail audio players. Likely candidates (names may vary):
     - client/src/components/phone/VoicemailInbox.tsx
     - client/src/components/messages/MessageBubble.tsx
     - Any dedicated VoicemailPlayer component.

2) ADD BACKEND PROXY ROUTE
   - In the server (Node/Express area where Twilio routes live, likely server/routes.twilioVoice.ts or a related file), add a new route something like:

     GET /api/twilio/media/:recordingSid

   - Behavior:
     - Validate the request (ensure an authenticated user, and tenant is resolved as it is in other internal routes).
     - Use the Twilio Node SDK with TWILIO_ACCOUNT_SID and TWILIO_AUTH_TOKEN to fetch the recording media.
       - You can either:
         a) Use the Recordings API to get the recording URI and then stream it, or
         b) Use the “/Recordings/{sid}.mp3” style URL.
     - Stream the audio back to the client with the correct Content-Type (audio/mpeg or audio/wav depending on Twilio).
     - Do NOT expose the Twilio credentials or raw api.twilio.com URL to the client.

   - Make sure the route is multi-tenant-safe:
     - Only allow access if the caller belongs to the tenant that owns the phone line / call.
     - Do basic guardrails so one tenant can’t fetch another tenant’s recordings.

3) UPDATE CLIENT TO USE PROXY
   - Wherever voicemail audio is rendered, change the src to use the new proxy:
     - Instead of src={metadata.recordingUrl} or a Twilio URL,
       use something like src={`/api/twilio/media/${recordingSid}`}.
     - recordingSid should already be in metadata; if not, store it when syncing voicemail (metadata.recordingSid).

4) VERIFY
   - Open /messages and /phone in an incognito window.
   - Load a voicemail thread.
   - Confirm:
     - The audio player appears and plays correctly.
     - No Twilio login popup appears.
     - Network tab shows calls to /api/twilio/media/... (not api.twilio.com).

--------------------------------
TASK 2 – Fix inbound SMS AI fallback (“I didn’t generate a proper response”)
--------------------------------

Problem: When I text the main line, I often receive the generic SMS:

   "I apologize, but I didn't generate a proper response. Try again."

This indicates:
- Twilio → /api/twilio/sms/inbound is working, BUT
- The AI pipeline in the SMS inbound route is falling through to a generic fallback, instead of using the same tool-calling loop as the web chat.

Goal: Make inbound SMS use the *same robust OpenAI + tool-calling loop* as the web chat, and only send that generic apology when there is a real error. If AI fails, send a Clean-Machine flavored fallback.

Steps:

1) FIND SMS INBOUND ROUTE AND FALLBACK STRING
   - Find the Express route that handles /api/twilio/sms/inbound.
     - Search for that path and for the fallback string:
       "I apologize, but I didn't generate a proper response."
   - Identify how this route currently:
     - Resolves tenant / phone line
     - Fetches/creates the conversation
     - Calls OpenAI
     - Decides what text to reply with

2) FIND WORKING WEB CHAT AI LOOP
   - Locate the code path used by the web chat that *does* work well.
     - Look for a function that:
       - Calls OpenAI with tools enabled,
       - Handles response.tool_calls,
       - Executes tools (e.g. get_available_appointments, schedule_appointment, etc.),
       - Re-queries OpenAI until it gets a normal text response.
   - Identify that “canonical AI dispatch” function or pattern (even if it’s inline somewhere).

3) REFRACTOR SMS INBOUND TO USE THE SAME PATTERN
   - Extract or reuse a shared function that:
     - Takes: { tenantId, channel: 'sms', conversationId, incomingMessage, phone metadata }, etc.
     - Runs the same OpenAI + tool-calling loop as web chat.
     - Returns a final text response for SMS (or throws an error if truly impossible).
   - Update the /api/twilio/sms/inbound handler to:
     - Use this shared function.
     - Only send the generic apology if:
       - OpenAI errors out, OR
       - A tool call fails in a way we can’t recover from.
   - For now, change the fallback to a more useful Clean-Machine style message, for example:

     "We got your message and will follow up as soon as we can. If it’s urgent, feel free to call or text again."

   - Make sure:
     - Multi-tenant routing is preserved.
     - We still mark conversations as needing human attention when appropriate.

4) LOGGING
   - Add concise server-side logging (console.log or a logger) for the SMS path:
     - Log when we hit the fallback due to error, including:
       - tenantId
       - from / to numbers
       - high-level error message (no secrets).
   - This will help debug any future issues.

5) VERIFY
   - Text the main line from a test phone.
   - Confirm:
     - A conversation is created/updated in /messages.
     - The AI responds with a normal, contextual Clean Machine reply (not the generic apology).
   - Test at least one case where the AI should use tools (e.g. appointment-style question) and confirm the loop works.

--------------------------------
TASK 3 – Fix outbound call “application error” path
--------------------------------

Problem: In the app, when I click “Call” (from the Phone tab or from a thread), my Groundwire softphone rings, I answer, and Twilio plays “We’re sorry, an application error has occurred” instead of connecting me to the customer. So outbound calls through the app are not bridging correctly.

Goal: Clicking “Call” on a customer in the app should do a proper Twilio outbound two-leg call:
- Leg 1: Twilio → my SIP endpoint (Groundwire).
- Leg 2: Twilio → customer’s phone number.
- When I answer on Groundwire, the customer is bridged into the call.
- No “application error” message.

Steps:

1) FIND OUTBOUND CALL ROUTE
   - Find the server route used when the Phone/Dialer UI or Messages thread “Call” button is clicked.
     - Search for routes like:
       - POST /api/phone/call
       - POST /api/voice/outbound
       - or look for usage of the Twilio Voice SDK / Calls API where “to” is a phone number and “from” is MAIN_PHONE_NUMBER.
   - Identify current behavior:
     - Does it use the TwiML App?
     - Does it hit your canonical /twilio/voice/incoming handler?
     - Or is it using inline TwiML that might be outdated?

2) ALIGN WITH CANONICAL VOICE FLOW
   - We already have a canonical voice entry point /twilio/voice/incoming used for inbound.
   - Outbound calls from the app should be consistent and safe.
   - Make sure the outbound call creation:
     - Uses Twilio’s Calls API with:
       - from: MAIN_PHONE_NUMBER (or the correct per-tenant number)
       - to: either:
         - a Sip URI for my softphone, or
         - a Twilio Client identifier if applicable
       - and/or sets “url” to a TwiML App that knows how to bridge the call.
   - If you already have a bridging TwiML flow for outbound, ensure it points at valid URLs and that those URLs are implemented on this app (not the old Clean Machine repl).

   The goal is: when I click Call in the app:
   - My Groundwire rings.
   - When I answer, the customer is called and bridged.
   - If something fails, log a clear error on the server (and return a clear error to the UI), not a generic “application error”.

3) FIX ANY HARDCODED OLD HOSTNAMES
   - Double-check that no outbound call logic references:
     - Old Clean Machine repl URLs
     - Stale TwiML App URLs
   - All Twilio “url” and “statusCallback” parameters should point to:
     - https://servicepro-v-3-base-cleanmachinetul.replit.app/twilio/voice/incoming
     - https://servicepro-v-3-base-cleanmachinetul.replit.app/twilio/voice/call-status
     (or equivalent canonical routes already in this project)

4) VERIFY
   - From the app’s Phone tab or a thread:
     - Click Call for a test number.
   - Confirm:
     - Groundwire rings; you answer.
     - The customer phone rings.
     - You can speak both ways; no Twilio application error message.
   - Check Twilio Console logs for any remaining 11200/15003 errors and fix if they are due to bad URLs.

--------------------------------
TASK 4 – Messages page thread column / scroll sanity
--------------------------------

Problem: The Messages (Night Ops) page currently feels cramped and partially broken:
- The thread column (middle) is too narrow.
- Scroll behavior sometimes prevents reaching the input area for some threads.
- On a laptop screen, it feels “squished” and difficult to use.

Goal: Without redesigning the entire UI, make a *light, targeted* layout pass so:
- The thread column is clearly the primary column and has enough width.
- Inbox, Thread, and Context panels are laid out in a way that works well on normal laptop widths.
- Scroll works correctly; you can always scroll the thread and reach the input.

Steps:

1) FIND LAYOUT COMPONENTS
   - Identify the main layout components for the Messages page:
     - Likely something like:
       - client/src/components/messages/NightOpsMessagesLayout.tsx
       - client/src/components/messages/ThreadView.tsx
   - Identify where flexbox / grid is used to define the three-column layout.

2) MAKE THREAD COLUMN PRIMARY
   - Adjust the layout so that on desktop widths:
     - Inbox sidebar: narrower.
     - Context sidebar: narrower.
     - Thread column: wider (approx 50–60% width).
   - Example:
     - Use CSS grid or flex with basis like: 22% / 50–56% / 22–28%, instead of roughly equal widths.
   - Do NOT remove any functionality; just re-balance width.

3) FIX SCROLL
   - Ensure the thread column:
     - Uses flex or grid so that:
       - Header, message list, and composer are stacked vertically.
       - The message list area has overflow-y: auto.
   - Make sure the scroll-to-bottom logic still works (whatever hook or effect you use today).
   - Confirm you can:
     - Scroll up to older messages.
     - Scroll down to the input in long threads.
   - Make sure Inbox scroll and Context scroll remain independent of Thread scroll.

4) RESPONSIVE CHECK
   - At least do a basic check for:
     - ~1440px width (laptop)
     - ~1024px width (smaller laptop/tablet width)
   - Ensure no catastrophic behavior (columns overlapping, thread entirely squeezed to nothing).
   - It’s OK if mobile is not perfect yet; just avoid making things worse.

5) VERIFY
   - Open /messages in a normal browser window (not maximized ultra-wide).
   - Click several threads including:
     - A short conversation.
     - A long conversation.
     - A voicemail-heavy conversation.
   - Confirm:
     - You can see messages comfortably.
     - You can always reach the input.
     - The layout feels usable, not “wrecked”.

--------------------------------
DELIVERABLE
--------------------------------

When finished:

1) List all files changed.
2) For each of the 4 tasks above, describe:
   - Old behavior
   - New behavior
3) Call out any remaining known limitations or TODOs that you recommend for a future “Messages v2 polish” or “IVR configurator” phase, but don’t block this set of fixes on those.
