You are editing my ServicePro v3 multi-tenant repo.

Your task: 
1) Find the existing master plan document. 
2) Overwrite its contents with the exact MASTER PLAN v3.3 text below.
3) Do NOT create duplicate master-plan files.

====================================================
STEP 1 â€“ LOCATE EXISTING MASTER PLAN FILE
====================================================

1. Search for a file that contains a heading similar to:
   - "MASTER PLAN v3." 
   - Or "MASTER PLAN â€“ SERVICEPRO MULTI-TENANT SUPER-SYSTEM"

2. This file might be:
   - At repo root (e.g. `MASTER_PLAN.md`)
   - Under `docs/` or similar

3. Once found, treat that file as the canonical master plan file.
   - Do NOT create a second file.
   - Overwrite that fileâ€™s contents completely with the v3.3 text below.

====================================================
STEP 2 â€“ OVERWRITE CONTENTS WITH MASTER PLAN v3.3
====================================================

Replace the file contents with EXACTLY this markdown:

----------------------------------------------------------------
# MASTER PLAN v3.3 â€“ SERVICEPRO MULTI-TENANT SUPER-SYSTEM

Canonical blueprint for:
- Jody (founder)
- Partner(s)
- Replit AI agents
- Future human contributors

This file is the single source of truth for:
- Architecture decisions
- Phase roadmap (0â€“22)
- Telephony and SMS/voice routing
- AI agent behavior (SMS, voice, admin)
- White-label / branding and agency features

All significant changes to the platform MUST be reflected here.

---

## 0. NORTH STAR

**Product Vision**

Turn the original Clean Machine app into **ServicePro** â€” a multi-tenant, AI-powered operating system for service-based businesses:

- Auto detailing (Clean Machine, other cities)
- Lawn care
- House cleaning
- Mobile pet grooming
- Photography
- Other local services

**Clean Machine** is the **root tenant** (`tenant_id = 'root'`), the flagship instance.

Other businesses are **child tenants**, each with:

- Their own Twilio numbers
- Their own branding, website, and colors
- Their own services, pricing, and industry pack
- Their own AI agents:
  - Onboarding/setup
  - Customer booking agent
  - Ongoing customer support agent

Shared across all tenants:

- One codebase
- One telephony â€œsuper-tenantâ€ architecture
- One AI framework, customized per industry and per tenant

---

## 1. CURRENT STATE SNAPSHOT (v3.3)

### 1.1 Backend & Architecture

- Node.js + Express + TypeScript
- Drizzle ORM + Neon/Postgres
- Multi-tenant database with `tenant_id` on core tables
- `tenantDb` helper and `tenantMiddleware` to enforce isolation
- Routes for:
  - appointments
  - customers
  - campaigns
  - loyalty
  - SMS and notifications
  - admin/tenant management

### 1.2 Frontend

- React + Vite
- Tenant dashboard pages:
  - SMS
  - Calendar
  - Customers
  - Campaigns
  - Settings
- Admin (owner-only) pages:
  - Tenants
  - Phone & IVR config
  - Plan tiers
- Customer-facing:
  - Booking flows (root tenant, more to come)
  - Customer portal groundwork
  - Loyalty welcome / portal welcome page

### 1.3 Telephony Spine

- Twilio integration for SMS and voice
- Canonical voice entry route: `POST /twilio/voice/incoming`
- Inbound SMS: `POST /sms`
- `tenant_phone_config` table:
  - `tenant_id`
  - `phone_number` (E.164)
  - `messaging_service_sid`
  - SIP credentials (for forwarding)
  - `ivr_mode: 'simple' | 'ivr' | 'ai-voice'`

### 1.4 AI & Automation

- Early SMS helpers for intelligent responses
- Voice:
  - `ivr_mode = 'ivr'`: standard DTMF menus
  - `ivr_mode = 'simple'`: forward to SIP/cell
  - `ivr_mode = 'ai-voice'`: new AI receptionist entry (static TTS for now)
- Foundations laid for:
  - AI SMS agent
  - AI voice concierge
  - Admin â€œcopilotâ€ assistant

---

## 2. PHASE ROADMAP (0â€“22 OVERVIEW)

Legend:
- âœ… = complete in code
- ğŸŸ¡ = in progress / next up
- ğŸ“ = designed / future

| Phase | Name                                           | Status |
|-------|------------------------------------------------|--------|
| 0     | Canonicalization & Master Docs                 | âœ…     |
| 1     | Tenant Isolation & Multi-Tenant Core          | âœ…     |
| 2     | Telephony Spine (SMS, Voice, SIP, IVR)         | âœ…     |
| 3     | Tenant Communication Router                    | âœ…     |
| 4     | AI Voice Concierge Entry Point                 | âœ…     |
| 5     | Concierge Setup Dashboard (Owner-only)         | ğŸ“     |
| 6     | Impersonate Tenant (â€œLogin asâ€¦â€)               | ğŸ“     |
| 7     | Tiers, Billing & Plan Features (core gating)   | âœ…     |
| 8     | Industry Packs & Auto-Setup                    | ğŸ“     |
| 9     | Website Generator (Templates + White-Label)    | ğŸ“     |
| 10    | AI Setup & Support Agents (Admin copilot)      | ğŸ“     |
| 11    | Data Export & Retention                        | ğŸ“     |
| 12    | Integrations & Keys Checklist                  | ğŸ“     |
| 13    | Idea Parking Lot / Future Enhancements         | ğŸ“     |
| 14    | SMS Super-Agent Roadmap Index                  | ğŸ“     |
| 15    | SMS Inbound Brain & Context Router             | ğŸ“     |
| 16    | SMS Agent + Industry Packs Integration         | ğŸ“     |
| 17    | White-Label / Branding + Custom Domains        | ğŸ“     |
| 18    | ServicePro Support Concierge (Admin AI helper) | ğŸ“     |
| 19    | Analytics + Showcase Dashboards                | ğŸ“     |
| 20    | Template / Clone-a-Tenant Factory              | ğŸ“     |
| 21    | Advanced Analytics & Revenue Intelligence      | ğŸ“     |
| 22    | Agency Mode (Super-White-Label)                | ğŸ“     |

The rest of this document defines each phase in more detail.

---

## 3. PHASE 1 â€“ TENANT ISOLATION & MULTI-TENANT CORE âœ…

**Goal:** one shared codebase, many tenants, no data leaks.

Key pieces:

- `tenantDb` wrapper:
  - Injects `tenant_id` on writes
  - Filters by `tenant_id` on reads
- `tenantMiddleware`:
  - Resolves current tenant from:
    - auth / session
    - domain or subdomain (future)
    - inbound phone mapping (for SMS/voice routes)
  - Attaches:
    - `req.tenant`
    - `req.tenantDb`
- Backfilling:
  - Root tenant (`tenant_id = 'root'`) owns legacy Clean Machine data
- Tests:
  - DB writes/reads are tenant-scoped
  - No cross-tenant leakage

Status: COMPLETE.

---

## 4. PHASE 2 â€“ TELEPHONY SPINE âœ…

**Goal:** One canonical, per-tenant-aware telephony entry.

Components:

- `/twilio/voice/incoming`:
  - Verifies Twilio signature
  - Uses `resolveTenantFromInbound` for tenant + phone config
  - Branches on `ivr_mode`:
    - `'simple'` â†’ forward/SIP
    - `'ivr'` â†’ IVR DTMF menu
    - `'ai-voice'` â†’ AI voice entry (Phase 4)
- `tenant_phone_config`:
  - `tenant_id`
  - E.164 phone number
  - messaging service SID
  - SIP config
  - `ivr_mode`
- Admin Phone Config UI (Phase 2.5):
  - Manage phone configs per tenant
  - Select IVR mode
  - Validation & tests

Status: COMPLETE.

---

## 5. PHASE 3 â€“ TENANT COMMUNICATION ROUTER âœ…

**Goal:** unify inbound SMS + voice resolution.

- `resolveTenantFromInbound` service:
  - Input:
    - `From`, `To`, `MessagingServiceSid`, etc.
  - Resolution order:
    1. `MessagingServiceSid` â†’ tenant
    2. `To` phone number â†’ `tenant_phone_config`
    3. Fallback: root (for error handling/local dev)
  - Output:
    - `tenantId`
    - `tenant`
    - `phoneConfig`
    - `ivrMode`
- Used by:
  - `/sms`
  - `/twilio/voice/incoming`
  - `/twilio/voice/ai`

Status: COMPLETE.

---

## 6. PHASE 4 â€“ AI VOICE CONCIERGE ENTRY POINT âœ…

**Goal:** Provide an AI-voice-compatible route now, even before true streaming AI.

Components:

- `/twilio/voice/ai`:
  - Verifies Twilio
  - Uses `resolveTenantFromInbound`
  - If `ivrMode !== 'ai-voice'` or misconfigured:
    - Returns safe fallback TwiML
- `aiVoiceSession.handleAiVoiceRequest`:
  - Returns TwiML `<Say>`:
    - Greets caller by business name
    - Explains â€œAI-style receptionist (beta)â€
    - Asks caller what they need
- Integration:
  - `/twilio/voice/incoming` routes AI calls here if `ivrMode = 'ai-voice'`

Status: COMPLETE. Future phases can swap the static TTS with streaming OpenAI Realtime / ElevenLabs.

---

## 7. PHASE 5 â€“ CONCIERGE SETUP DASHBOARD (OWNER-ONLY) ğŸ“

**Goal:** Owner-only control room to create/configure tenants in one flow.

Key features:

- Route: `/admin/concierge-setup` (owner-only)
- Backend:
  - `POST /api/admin/concierge/tenants`:
    - Creates tenant
    - Sets `planTier` + `status`
    - Creates `tenant_config` (industry, city, branding, notes)
    - Creates `tenant_phone_config` (phone number, ivr mode, messaging service SID)
    - Optionally triggers onboarding email/SMS
- UI sections:
  - Tenant basics (business name, city, contact)
  - Plan tier + status (starter/pro/elite/internal, trialing/active/etc.)
  - Industry selection (detailing, lawn care, cleaning, etc.)
  - Telephony (number, messaging service SID, IVR mode)
  - Website/branding basics (optional)
  - Onboarding messaging (welcome email/SMS toggles)
- After creation:
  - Show summary card
  - Provide:
    - â€œOpen tenant in impersonate modeâ€ (Phase 6 integration)
    - â€œCreate another tenantâ€

Status: DESIGNED, not implemented.

---

## 8. PHASE 6 â€“ IMPERSONATE TENANT (â€œLOGIN ASâ€¦â€) ğŸ“

**Goal:** Owner-only â€œGod Modeâ€ to view and fix things as a tenant.

Key ideas:

- Auth model extension:
  - Keep track of:
    - Real user (owner)
    - Effective tenant & role
- UI:
  - From Admin Tenants / Concierge pages:
    - â€œLogin as [Tenant Name]â€
  - Show a banner in the tenant dashboard:
    - â€œViewing as [Tenant], click here to exit impersonationâ€
- Logging:
  - Log impersonation start/stop events
  - Tag changes made during impersonation

Status: DESIGNED.

---

## 9. PHASE 7 â€“ TIERS, BILLING & PLAN FEATURES (CORE) âœ…

**Goal:** Enable feature-gating by plan tier, independent of Stripe.

- `tenants` table:
  - `planTier: 'starter' | 'pro' | 'elite' | 'internal'`
  - `status: 'trialing' | 'active' | 'past_due' | 'suspended' | 'cancelled'`
- Root tenant:
  - `planTier = 'elite'`
  - `status = 'active'`
- Feature map:
  - `FEATURE_KEYS` enum/type
  - `TIER_FEATURES` mapping:
    - `starter`: basics only
    - `pro`: campaigns, AI SMS, etc.
    - `elite`: everything (AI voice, advanced features)
    - `internal`: everything (for friends/family/demo)
- Helper:
  - `hasFeature(tenant, key)`:
    - Used in backend routes and frontend UI to gate features.
- Admin Tenants:
  - Shows tier + status
  - Owner-only control for changing them

Status: COMPLETE.  
Stripe subscription flows will be tackled in Phase 7B later.

---

## 10. PHASE 8 â€“ INDUSTRY PACKS & AUTO-SETUP ğŸ“

**Goal:** Remove â€œblank slateâ€ paralysis. New tenants get a smart default setup.

- Per-industry packs:
  - Services + durations + base prices
  - Add-ons and upsells
  - FAQ entries
  - Tone & vocab guidelines
  - SMS templates (booking, reminders, promos)
  - Website sections & copy suggestions
- Applied via:
  - Concierge dashboard (Phase 5)
  - Future self-serve onboarding

Status: DESIGNED.

---

## 11. PHASE 9 â€“ WEBSITE GENERATOR (TEMPLATES + WHITE-LABEL) ğŸ“

**Goal:** Let tenants spin up a high-end website thatâ€™s fueled by their ServicePro data.

- 6â€“10 curated React/Tailwind templates
- Driven by a `WebsiteSeed` object (name, city, services, photos)
- Tenant can:
  - Pick a template
  - Change colors, copy, hero, CTAs
  - Link to booking portal
- Hooks into:
  - Custom domain & branding (Phase 17)
  - Industry packs for default content

Status: DESIGNED.

---

## 12. PHASE 10 â€“ AI SETUP & SUPPORT AGENTS (ADMIN COPILOT) ğŸ“

**Goal:** An in-dashboard â€œcopilotâ€ that understands the product and config.

Capabilities:

- Knows:
  - Tenant plan & industry
  - Current page (route)
  - Industry pack
  - Core settings (phone, IVR, campaigns)
- Can:
  - Explain what a setting does
  - Suggest values (e.g., an IVR script, a default campaign)
  - Propose next steps in onboarding

Integration:

- Backend:
  - `/api/ai/admin-assistant`
- Frontend:
  - Docked â€œNeed help?â€ chat bubble
  - Opens assistant pane with context: current route + tenant

Status: DESIGNED.

---

## 13. PHASE 11 â€“ DATA EXPORT & RETENTION ğŸ“

**Goal:** Provide per-tenant data exports while respecting retention policies.

Exports include:

- Customers
- Appointments
- Messages (SMS/voice transcripts)
- Campaign history
- Loyalty ledger

Requirements:

- Suspended tenants can still export within a retention window
- Exports generated asynchronously (background jobs)
- Secure download links with expiry

Status: DESIGNED.

---

## 14. PHASE 12 â€“ INTEGRATIONS & KEYS CHECKLIST ğŸ“

**Goal:** Make it easy to onboard infrastructure for you + your partner.

Platform-level envs:

- Postgres
- OpenAI
- Twilio (super-tenant)
- Stripe
- SendGrid
- Google APIs

Per-tenant config (in DB):

- Telephony config (phone, messaging service SID, IVR mode)
- Website + branding
- Industry choice
- AI preferences

Status: Checklist / design only.

---

## 15. PHASE 13 â€“ IDEA PARKING LOT ğŸ“

Collection of future â€œnice to haveâ€ features:

- PWA call console (web softphone)
- Technician iPad advanced mode
- Deep review funnel + widgets
- AI revenue analytics per tenant
- More advanced gamification layers

Status: Ongoing idea bin.

---

## 16. PHASE 14 â€“ SMS SUPER-AGENT ROADMAP INDEX ğŸ“

**Goal:** Document the SMS agentâ€™s multi-phase roadmap and link it to this master plan.

Deliverable:

- A doc (or section) listing SMS Agent Phase 1â€“22:
  - Short description each
  - Status (âœ…/ğŸŸ¡/ğŸ“)
  - Mapping to ServicePro phases, e.g.:
    - SMS Phase 1â€“3 â†’ Phase 3 (routing)
    - SMS Phase 4â€“8 â†’ Phase 15 (brain + context)
    - etc.

Status: DOCUMENTATION ONLY.

---

## 17. PHASE 15 â€“ SMS INBOUND BRAIN & CONTEXT ROUTER ğŸ“

**Goal:** Turn `/sms` into a smart â€œagent brainâ€ instead of simple keyword logic.

Key components:

- `SmsAgentBrain`:
  - `classifyIntent(message, customer, tenantConfig)`
  - `buildContext(customer, history, tenantConfig)`
  - `routeTask(intent, context)` â†’ booking/FAQ/loyalty/handoff
- Intent types:
  - New booking
  - Change/cancel booking
  - Price/services questions
  - Loyalty/points questions
  - Generic â€œwhat do you do?â€
  - Spam/unknown
- Handlers:
  - Booking handler
  - FAQ handler
  - Loyalty handler
  - Fallback handler

Status: DESIGNED.

---

## 18. PHASE 16 â€“ SMS AGENT + INDUSTRY PACKS INTEGRATION ğŸ“

**Goal:** Make the SMS agent speak appropriately for each industry and tenant.

Hookups:

- Agent context includes:
  - `industryPack` (services, FAQs, tone)
  - Tenant overrides (custom services, policies)
- FAQ handler:
  - Searches pack FAQs + services
- Response tone:
  - Uses packâ€™s tone guidelines (e.g., relaxed vs. premium, etc.)

Status: DESIGNED.

---

## 19. PHASE 17 â€“ WHITE-LABEL / BRANDING + CUSTOM DOMAINS ğŸ“

**Goal:** Make each tenantâ€™s experience feel like â€œtheir ownâ€ platform.

Branding:

- Per-tenant logo, colors, business name override
- Option to show/hide â€œPowered by ServiceProâ€:
  - Auto-on for starter tier
  - Off for elite/internal
- Overrides for:
  - Booking pages
  - Customer portal
  - Some dashboard surfaces
  - Email templates (logo + colors)

Domains:

- Subdomains:
  - `tenant.servicepro.app`
- Custom domains:
  - `www.clientbrand.com`
- Infrastructure:
  - DNS verification
  - SSL certificates
  - Routing middleware that maps host â†’ tenant

Status: DESIGNED.

---

## 20. PHASE 18 â€“ SERVICEPRO SUPPORT CONCIERGE (ADMIN AI HELPER) ğŸ“

**Goal:** Provide an AI support agent inside the admin UI to reduce human support.

Features:

- Lives in admin dashboard:
  - â€œAsk ServicePro Assistantâ€ dock
- Knows:
  - Tenant plan & industry
  - Current page / route
  - Core docs and definitions
  - Onboarding flow
- Can:
  - Explain features
  - Suggest configurations
  - Draft IVR scripts
  - Draft campaign copy
  - Propose fixes for common issues (e.g., Twilio misconfig)

Status: DESIGNED.

---

## 21. PHASE 19 â€“ ANALYTICS + SHOWCASE DASHBOARDS ğŸ“

**Goal:** Show real value to tenants and to you.

Tenant Analytics:

- Bookings over time
- Revenue
- No-shows
- Repeat customer rate
- Channel breakdown (SMS/web/voice)
- Loyalty usage (points issued/redeemed)
- Campaign performance

Owner Analytics (you):

- Tenants sorted by:
  - Revenue
  - Activity
  - Messages/day
  - Health score
- Platform-wide:
  - Revenue
  - AI-assisted bookings
  - Active vs. churned tenants

Showcase Mode:

- Anonymized stats for:
  - Marketing demos
  - Investor overview
  - Public landing page

Status: DESIGNED.

---

## 22. PHASE 20 â€“ TEMPLATE / CLONE-A-TENANT FACTORY ğŸ“

**Goal:** Onboard new tenants extremely fast by cloning proven setups.

Template system:

- Mark a tenant as a template:
  - â€œPhotography â€“ Premiumâ€
  - â€œDetailer â€“ Tulsa Eliteâ€
- Clone:
  - Services and pricing
  - Add-ons and upsells
  - FAQ entries
  - Tone settings
  - Website template choice
  - Default campaigns
  - Loyalty rules

Integration:

- Concierge Setup (Phase 5):
  - â€œCreate from templateâ€ option

Status: DESIGNED.

---

## 23. PHASE 21 â€“ ADVANCED ANALYTICS & REVENUE INTELLIGENCE ğŸ“

**Goal:** Deeper BI layer and predictive insight.

Tenant & platform-level metrics:

- LTV estimates
- Churn risk estimates
- Seasonal trends
- Agent impact on revenue (conversion boost)
- Bottleneck analysis (where customers drop out)

Requires:

- `analytics_events` table with structured event types
- Aggregation jobs
- ML-ish or heuristic scoring (simple at first)

Status: DESIGNED.

---

## 24. PHASE 22 â€“ AGENCY MODE (SUPER-WHITE-LABEL) ğŸ“

**Goal:** Let agencies resell ServicePro under their own brand.

New role:

- `agency_admin`:
  - Manages multiple tenants
  - Has their own branding and domain
  - Creates templates for their niche

Model:

- `agencies` table
- `agency_id` on tenants
- Agency billing:
  - You bill the agency
  - Agency bills their end clients

Branding layers:

- Platform brand (your master brand)
- Agency brand
- Tenant brand

Status: CONCEPTUAL, long-term roadmap.

---

## TL;DR â€“ CURRENT FOCUS

- Telephony spine & tenant routing: âœ… solid
- Plan tiers & feature gating: âœ… implemented
- AI voice entry: âœ… placeholder, ready for real streaming integration
- NEXT MAJOR BUILDS:
  - Phase 5 â€“ Concierge Setup Dashboard
  - Phase 6 â€“ Impersonate Tenant
  - Phase 8 â€“ Industry Packs
  - Phase 14â€“16 â€“ SMS Super-Agent brain + industry integration
  - Phase 17â€“20 â€“ White-label, analytics, templates

----------------------------------------------------------------

====================================================
STEP 3 â€“ FINALIZE
====================================================

After overwriting the master plan file with the v3.3 text above:

- Ensure there is ONLY ONE master plan file in the repo.
- Do NOT leave older v3.0/v3.1/v3.2 duplicates around.
- From now on, treat this MASTER PLAN v3.3 file as the canonical roadmap for all future changes.
