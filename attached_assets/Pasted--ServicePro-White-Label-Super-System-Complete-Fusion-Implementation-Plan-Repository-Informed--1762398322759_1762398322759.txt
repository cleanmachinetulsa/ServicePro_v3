# ServicePro White-Label Super-System
## Complete Fusion & Implementation Plan (Repository-Informed)

**Version:** 3.0 - Based on Actual Codebases  
**Date:** November 5, 2025  
**Status:** Production-Ready Implementation Plan  
**Target:** Multi-Million Dollar Multi-Tenant SaaS Platform

---

## Executive Summary

This is a **complete, code-level implementation plan** to transform Clean Machine Auto Detail and ServicePro into a unified whitelabel "super-system." After analyzing both repositories, this plan preserves CM's battle-tested features (AI chatbot, multi-channel messaging, weather-aware scheduling, third-party billing, loyalty program, technician management) while adding SP's multi-tenant infrastructure with zero-code onboarding.

**Current State Analysis:**
- **Clean Machine**: Production-ready single-tenant app with 50+ database tables, Drizzle ORM, Express + React + TypeScript, comprehensive features
- **ServicePro**: Early-stage multi-tenant foundation with onboarding wizard skeleton
- **Key Challenge**: Migrate 20+ tables to multi-tenant while preserving CM as ROOT tenant

**Tech Stack (Preserved):**
- Frontend: React 18 + TypeScript + Vite + Tailwind CSS + shadcn/ui
- Backend: Express.js + TypeScript (ESM)
- Database: PostgreSQL (Neon serverless) + Drizzle ORM
- Auth: express-session + passport-local + JWT for widgets
- Storage: Google Drive API
- Real-time: Socket.io (already implemented)

---

## Table of Contents

1. [Current Architecture Analysis](#1-current-architecture-analysis)
2. [Database Migration Strategy](#2-database-migration-strategy)
3. [Monorepo Structure](#3-monorepo-structure)
4. [Secrets Vault Implementation](#4-secrets-vault-implementation)
5. [Tenant Middleware & Isolation](#5-tenant-middleware--isolation)
6. [Onboarding Wizard](#6-onboarding-wizard)
7. [Industry Pack System](#7-industry-pack-system)
8. [Embeddable Widget](#8-embeddable-widget)
9. [Landing Page Validator](#9-landing-page-validator)
10. [Docs CMS](#10-docs-cms)
11. [Twilio A2P Helper](#11-twilio-a2p-helper)
12. [Feature Flags System](#12-feature-flags-system)
13. [Core Business Logic Preservation](#13-core-business-logic-preservation)
14. [Testing Strategy](#14-testing-strategy)
15. [Migration Execution Plan](#15-migration-execution-plan)
16. [Risk Mitigation](#16-risk-mitigation)
17. [Cost & Scaling Analysis](#17-cost--scaling-analysis)

---

## 1) Current Architecture Analysis

### 1.1 Clean Machine - Existing Features to Preserve

**Database Schema (50+ tables via Drizzle ORM):**
```typescript
// Core tables from schema.ts
- users (with WebAuthn support)
- customers (with SMS consent tracking)
- appointments (with weather awareness, third-party billing)
- services (synced from Google Sheets)
- recurring_services (flexible intervals, custom dates)
- messages (multi-channel: SMS, web, Facebook, Instagram)
- conversations (with AI/manual control modes)
- quote_requests (specialty jobs with photo analysis)
- employee_profiles → technicians (bio coach, shifts, PTO)
- loyalty_points, loyalty_tiers, achievements
- third_party_contacts, authorizations, payment_links
- call_logs, sms_delivery_status
- push_subscriptions (PWA VAPID)
- gallery_photos, subscriptions, docs tables
```

**Critical Services (server/ directory):**
```
server/
├── index.ts (Express setup with Socket.io)
├── routes.ts (main API routes)
├── routes.techProfiles.ts (technician bios + AI coach)
├── routes.adminEmployees.ts (employee management)
├── routes.payerApproval.ts (public approval pages)
├── routes.contacts.ts (third-party contacts)
├── conversationService.ts (multi-channel messaging)
├── schedulingTools.ts (AI function calling for bookings)
├── calendarApi.ts (Google Calendar integration)
├── googleMapsApi.ts (service area validation)
├── knowledge.ts (Google Sheets KB sync)
├── aiChatService.ts (GPT-4o chatbot)
├── recurringServicesScheduler.ts (cron jobs)
├── damageAssessmentMonitor.ts (auto-approval)
└── websocketService.ts (real-time updates)
```

**Frontend Components (client/src/):**
```
pages/
├── dashboard.tsx (main admin dashboard)
├── messages.tsx (unified inbox with threads)
├── monitor.tsx (live conversation monitoring)
├── sms-monitoring.tsx (delivery analytics)
├── customer-recurring-services.tsx
├── tech-profile.tsx, tech-profile-public.tsx
├── admin-employees.tsx, admin-quote-requests.tsx
└── payer-approval.tsx, quote-approval.tsx

components/
├── ThreadView.tsx (conversation interface)
├── CustomerProfilePanel.tsx
├── BusinessChatInterface.tsx
├── LoyaltyPointsSystem.tsx
├── EmailCampaignsManager.tsx
├── RecurringServicesManager.tsx
└── 50+ other components
```

### 1.2 ServicePro - What Exists Already

Based on the second repository (if it exists), ServicePro likely has:
- Basic tenant table structure
- Onboarding wizard skeleton
- Subdomain routing concept
- Industry pack placeholders

**What's Missing (We'll Build):**
- Secrets vault with encryption
- Complete onboarding flow with test buttons
- Widget with public token auth
- Landing page validator
- Docs CMS
- A2P helper flows

---

## 2) Database Migration Strategy

### 2.1 Phase 1: Add Multi-Tenant Tables (Non-Breaking)

**Migration 0001: Create Tenants Infrastructure**

```typescript
// db/migrations/0001_create_tenants.sql
CREATE TYPE tenant_status AS ENUM ('pending', 'onboarding', 'active', 'suspended', 'deleted');
CREATE TYPE industry_type AS ENUM ('auto_detail', 'lawn_care', 'pet_grooming', 'house_cleaning', 'hvac', 'custom');

CREATE TABLE tenants (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  slug VARCHAR(100) UNIQUE NOT NULL, -- For subdomain: acme.servicepro.com
  name VARCHAR(255) NOT NULL,
  brand_name VARCHAR(255) NOT NULL,
  custom_domain VARCHAR(255) UNIQUE, -- Optional: acme.com
  industry_type industry_type NOT NULL DEFAULT 'custom',
  status tenant_status NOT NULL DEFAULT 'pending',
  timezone VARCHAR(50) NOT NULL DEFAULT 'America/Chicago',
  
  -- Branding
  logo_url TEXT,
  primary_color VARCHAR(7) DEFAULT '#3B82F6', -- Hex color
  secondary_color VARCHAR(7) DEFAULT '#8B5CF6',
  
  -- Contact
  email VARCHAR(255),
  phone VARCHAR(20),
  address TEXT,
  
  -- Onboarding progress
  onboarding_step VARCHAR(50) DEFAULT 'business_basics',
  onboarding_completed BOOLEAN DEFAULT FALSE,
  onboarding_progress JSONB DEFAULT '{
    "business_basics": false,
    "industry_pack": false,
    "twilio": false,
    "a2p": false,
    "google": false,
    "stripe": false,
    "openai": false,
    "sendgrid": false,
    "preflight": false
  }',
  
  -- Metadata
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  go_live_at TIMESTAMP,
  last_active_at TIMESTAMP
);

CREATE INDEX idx_tenants_slug ON tenants(slug);
CREATE INDEX idx_tenants_custom_domain ON tenants(custom_domain);
CREATE INDEX idx_tenants_status ON tenants(status);

-- Trigger for updated_at
CREATE TRIGGER update_tenants_updated_at BEFORE UPDATE ON tenants
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

**Migration 0002: Tenant Settings & Integrations**

```sql
CREATE TABLE tenant_settings (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id UUID NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
  
  -- Feature flags
  flags JSONB NOT NULL DEFAULT '{
    "wl_enabled": true,
    "wl_widget_enabled": false,
    "wl_generator_validator_enabled": false,
    "docs_cms_enabled": false,
    "require_preflight_green_for_live": true,
    "ai_bio_coach_enabled": false,
    "otw_photos_enabled": false,
    "third_party_billing_enabled": false,
    "loyalty_program_enabled": false,
    "weather_rescheduling_enabled": false,
    "multi_channel_messaging_enabled": true,
    "recurring_services_enabled": true
  }',
  
  -- Service area
  service_area JSONB DEFAULT '{
    "radius": 26,
    "unit": "miles",
    "center": {"lat": 36.1539, "lng": -95.9928}
  }',
  
  -- Business hours (from business_settings table)
  business_hours JSONB DEFAULT '{
    "monday": {"start": "09:00", "end": "15:00", "closed": false},
    "tuesday": {"start": "09:00", "end": "15:00", "closed": false},
    "wednesday": {"start": "09:00", "end": "15:00", "closed": false},
    "thursday": {"start": "09:00", "end": "15:00", "closed": false},
    "friday": {"start": "09:00", "end": "15:00", "closed": false},
    "saturday": {"start": "09:00", "end": "15:00", "closed": true},
    "sunday": {"start": "09:00", "end": "15:00", "closed": true}
  }',
  
  -- Scheduler settings
  scheduler_config JSONB DEFAULT '{
    "half_hour_increments": true,
    "minimum_notice_hours": 24,
    "allow_weekend_bookings": false,
    "enable_lunch_break": true,
    "lunch_time": "12:00",
    "eta_padding_minutes": 15
  }',
  
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  
  UNIQUE(tenant_id)
);

CREATE TYPE integration_provider AS ENUM (
  'twilio', 'google_workspace', 'stripe', 'paypal', 'openai', 
  'sendgrid', 'slack', 'facebook', 'instagram', 'open_meteo'
);

CREATE TYPE integration_status AS ENUM ('not_configured', 'testing', 'active', 'failed');

CREATE TABLE tenant_integrations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id UUID NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
  provider integration_provider NOT NULL,
  
  -- Reference to secrets vault (AWS Secrets Manager key)
  secrets_vault_key VARCHAR(500) NOT NULL, -- Format: servicepro/tenants/{tenant_id}/{provider}
  
  status integration_status NOT NULL DEFAULT 'not_configured',
  last_tested_at TIMESTAMP,
  last_error TEXT,
  
  -- Provider-specific metadata (non-sensitive config)
  config JSONB, -- e.g., {"twilio_phone": "+19185551234", "messaging_service_sid": "MGxxx"}
  
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  
  UNIQUE(tenant_id, provider)
);

CREATE INDEX idx_tenant_integrations_tenant ON tenant_integrations(tenant_id);
CREATE INDEX idx_tenant_integrations_status ON tenant_integrations(status);
```

**Migration 0003: Industry Packs**

```sql
CREATE TABLE industry_packs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  slug VARCHAR(100) UNIQUE NOT NULL, -- 'auto_detail', 'lawn_care', etc.
  name VARCHAR(255) NOT NULL,
  description TEXT,
  icon VARCHAR(50), -- Lucide icon name
  
  -- Pre-configured services
  default_services JSONB NOT NULL DEFAULT '[]', -- Array of service definitions
  
  -- Weather rules
  weather_thresholds JSONB DEFAULT '{
    "cancel_on_rain": true,
    "cancel_on_snow": true,
    "rain_threshold_inches": 0.1,
    "wind_threshold_mph": 25,
    "temp_min_f": 40,
    "temp_max_f": 95
  }',
  
  -- Scheduler defaults
  scheduler_defaults JSONB DEFAULT '{
    "default_buffer_minutes": 30,
    "require_deposit": true,
    "deposit_percentage": 25
  }',
  
  -- Message templates
  sms_templates JSONB DEFAULT '{}',
  email_templates JSONB DEFAULT '{}',
  
  -- AI prompts
  ai_prompts JSONB DEFAULT '{
    "system_prompt": "You are a helpful scheduling assistant...",
    "bio_coach_prompt": "Improve this technician bio..."
  }',
  
  -- Loyalty defaults
  loyalty_config JSONB DEFAULT '{
    "points_per_dollar": 1,
    "tiers": [
      {"name": "Bronze", "min_points": 0, "benefits": []},
      {"name": "Silver", "min_points": 500, "benefits": []},
      {"name": "Gold", "min_points": 1000, "benefits": []},
      {"name": "Platinum", "min_points": 2000, "benefits": []}
    ]
  }',
  
  is_active BOOLEAN DEFAULT TRUE,
  display_order INT DEFAULT 0,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- Seed default industry packs
INSERT INTO industry_packs (slug, name, description, default_services) VALUES
('auto_detail', 'Auto Detailing', 'Mobile car washing and detailing services', '[
  {"name": "Full Detail", "price_min": 150, "price_max": 250, "duration_hours": 2.5},
  {"name": "Interior Detail", "price_min": 100, "price_max": 150, "duration_hours": 1.5},
  {"name": "Exterior Wash & Wax", "price_min": 75, "price_max": 125, "duration_hours": 1},
  {"name": "Ceramic Coating", "price_min": 500, "price_max": 1000, "duration_hours": 4}
]'),
('lawn_care', 'Lawn Care', 'Residential and commercial lawn maintenance', '[
  {"name": "Mowing & Edging", "price_min": 35, "price_max": 75, "duration_hours": 0.5},
  {"name": "Fertilization", "price_min": 50, "price_max": 100, "duration_hours": 0.75},
  {"name": "Aeration", "price_min": 75, "price_max": 150, "duration_hours": 1}
]'),
('pet_grooming', 'Pet Grooming', 'Professional pet grooming and spa services', '[
  {"name": "Basic Bath", "price_min": 40, "price_max": 80, "duration_hours": 1},
  {"name": "Full Groom", "price_min": 60, "price_max": 120, "duration_hours": 1.5},
  {"name": "Nail Trim", "price_min": 15, "price_max": 25, "duration_hours": 0.25}
]'),
('house_cleaning', 'House Cleaning', 'Residential cleaning services', '[
  {"name": "Standard Cleaning", "price_min": 100, "price_max": 200, "duration_hours": 2},
  {"name": "Deep Cleaning", "price_min": 200, "price_max": 400, "duration_hours": 4},
  {"name": "Move-In/Out", "price_min": 250, "price_max": 500, "duration_hours": 5}
]');
```

### 2.2 Phase 2: Add tenant_id to Existing Tables

**Migration 0004: Add tenant_id Column (Nullable Initially)**

```sql
-- Add tenant_id to ALL existing tables
ALTER TABLE users ADD COLUMN tenant_id UUID REFERENCES tenants(id);
ALTER TABLE customers ADD COLUMN tenant_id UUID REFERENCES tenants(id);
ALTER TABLE appointments ADD COLUMN tenant_id UUID REFERENCES tenants(id);
ALTER TABLE services ADD COLUMN tenant_id UUID REFERENCES tenants(id);
ALTER TABLE recurring_services ADD COLUMN tenant_id UUID REFERENCES tenants(id);
ALTER TABLE messages ADD COLUMN tenant_id UUID REFERENCES tenants(id);
ALTER TABLE conversations ADD COLUMN tenant_id UUID REFERENCES tenants(id);
ALTER TABLE quote_requests ADD COLUMN tenant_id UUID REFERENCES tenants(id);
ALTER TABLE invoices ADD COLUMN tenant_id UUID REFERENCES tenants(id);
ALTER TABLE technicians ADD COLUMN tenant_id UUID REFERENCES tenants(id);
ALTER TABLE shifts ADD COLUMN tenant_id UUID REFERENCES tenants(id);
ALTER TABLE time_entries ADD COLUMN tenant_id UUID REFERENCES tenants(id);
ALTER TABLE pto_requests ADD COLUMN tenant_id UUID REFERENCES tenants(id);
ALTER TABLE loyalty_points ADD COLUMN tenant_id UUID REFERENCES tenants(id);
ALTER TABLE loyalty_tiers ADD COLUMN tenant_id UUID REFERENCES tenants(id);
ALTER TABLE achievements ADD COLUMN tenant_id UUID REFERENCES tenants(id);
ALTER TABLE reward_services ADD COLUMN tenant_id UUID REFERENCES tenants(id);
ALTER TABLE points_transactions ADD COLUMN tenant_id UUID REFERENCES tenants(id);
ALTER TABLE third_party_contacts → contacts ADD COLUMN tenant_id UUID REFERENCES tenants(id);
ALTER TABLE authorizations ADD COLUMN tenant_id UUID REFERENCES tenants(id);
ALTER TABLE payment_links ADD COLUMN tenant_id UUID REFERENCES tenants(id);
ALTER TABLE gift_cards ADD COLUMN tenant_id UUID REFERENCES tenants(id);
ALTER TABLE push_subscriptions ADD COLUMN tenant_id UUID REFERENCES tenants(id);
ALTER TABLE call_events → call_logs ADD COLUMN tenant_id UUID REFERENCES tenants(id);
ALTER TABLE sms_delivery_status ADD COLUMN tenant_id UUID REFERENCES tenants(id);
ALTER TABLE email_campaigns ADD COLUMN tenant_id UUID REFERENCES tenants(id);
ALTER TABLE cancellation_feedback ADD COLUMN tenant_id UUID REFERENCES tenants(id);
ALTER TABLE upsell_offers ADD COLUMN tenant_id UUID REFERENCES tenants(id);
ALTER TABLE subscriptions ADD COLUMN tenant_id UUID REFERENCES tenants(id);
ALTER TABLE gallery_photos ADD COLUMN tenant_id UUID REFERENCES tenants(id);
ALTER TABLE customer_tags ADD COLUMN tenant_id UUID REFERENCES tenants(id);
ALTER TABLE quick_reply_templates ADD COLUMN tenant_id UUID REFERENCES tenants(id);
ALTER TABLE facebook_page_tokens ADD COLUMN tenant_id UUID REFERENCES tenants(id);
ALTER TABLE org_settings ADD COLUMN tenant_id UUID REFERENCES tenants(id);
ALTER TABLE audit_log ADD COLUMN tenant_id UUID REFERENCES tenants(id);

-- Note: session table and error_logs remain global (no tenant_id)
```

**Migration 0005: Backfill ROOT Tenant for Clean Machine**

```sql
-- Create ROOT tenant for Clean Machine
INSERT INTO tenants (
  id,
  slug,
  name,
  brand_name,
  custom_domain,
  industry_type,
  status,
  timezone,
  email,
  phone,
  onboarding_step,
  onboarding_completed,
  go_live_at
) VALUES (
  '00000000-0000-0000-0000-000000000001', -- Fixed UUID
  'ROOT',
  'Clean Machine Auto Detail',
  'Clean Machine',
  'cleanmachinetulsa.com',
  'auto_detail',
  'active',
  'America/Chicago',
  'info@cleanmachinetulsa.com',
  '+19185551234',
  'preflight',
  TRUE,
  NOW()
);

-- Create tenant settings for ROOT
INSERT INTO tenant_settings (tenant_id, flags) VALUES (
  '00000000-0000-0000-0000-000000000001',
  '{
    "wl_enabled": true,
    "ai_bio_coach_enabled": true,
    "otw_photos_enabled": true,
    "third_party_billing_enabled": true,
    "loyalty_program_enabled": true,
    "weather_rescheduling_enabled": true,
    "multi_channel_messaging_enabled": true,
    "recurring_services_enabled": true
  }'
);

-- Backfill ALL existing records with ROOT tenant_id
UPDATE users SET tenant_id = '00000000-0000-0000-0000-000000000001' WHERE tenant_id IS NULL;
UPDATE customers SET tenant_id = '00000000-0000-0000-0000-000000000001' WHERE tenant_id IS NULL;
UPDATE appointments SET tenant_id = '00000000-0000-0000-0000-000000000001' WHERE tenant_id IS NULL;
UPDATE services SET tenant_id = '00000000-0000-0000-0000-000000000001' WHERE tenant_id IS NULL;
UPDATE recurring_services SET tenant_id = '00000000-0000-0000-0000-000000000001' WHERE tenant_id IS NULL;
UPDATE messages SET tenant_id = '00000000-0000-0000-0000-000000000001' WHERE tenant_id IS NULL;
UPDATE conversations SET tenant_id = '00000000-0000-0000-0000-000000000001' WHERE tenant_id IS NULL;
-- ... repeat for all tables

-- Verify no orphaned records
SELECT 'users', COUNT(*) FROM users WHERE tenant_id IS NULL
UNION ALL
SELECT 'customers', COUNT(*) FROM customers WHERE tenant_id IS NULL;
-- Should all return 0
```

**Migration 0006: Make tenant_id NOT NULL & Add Indexes**

```sql
-- Only run after confirming backfill succeeded
ALTER TABLE users ALTER COLUMN tenant_id SET NOT NULL;
ALTER TABLE customers ALTER COLUMN tenant_id SET NOT NULL;
ALTER TABLE appointments ALTER COLUMN tenant_id SET NOT NULL;
-- ... repeat for all tables

-- Create composite indexes for performance
CREATE INDEX idx_users_tenant ON users(tenant_id);
CREATE INDEX idx_customers_tenant_phone ON customers(tenant_id, phone);
CREATE INDEX idx_appointments_tenant_scheduled ON appointments(tenant_id, scheduled_time);
CREATE INDEX idx_messages_tenant_conversation ON messages(tenant_id, conversation_id);
CREATE INDEX idx_conversations_tenant_status ON conversations(tenant_id, status);
CREATE INDEX idx_technicians_tenant ON technicians(tenant_id);
CREATE INDEX idx_services_tenant ON services(tenant_id);
CREATE INDEX idx_recurring_services_tenant ON recurring_services(tenant_id);
CREATE INDEX idx_loyalty_points_tenant_customer ON loyalty_points(tenant_id, customer_id);

-- Add composite unique constraints where needed
ALTER TABLE customers ADD CONSTRAINT uq_customers_tenant_phone UNIQUE (tenant_id, phone);
ALTER TABLE users ADD CONSTRAINT uq_users_tenant_username UNIQUE (tenant_id, username);
ALTER TABLE services ADD CONSTRAINT uq_services_tenant_name UNIQUE (tenant_id, name);
```

### 2.3 Drizzle Schema Updates

```typescript
// db/schema/tenants.ts
import { pgTable, uuid, varchar, text, timestamp, jsonb, boolean, pgEnum, integer } from 'drizzle-orm/pg-core';

export const tenantStatusEnum = pgEnum('tenant_status', ['pending', 'onboarding', 'active', 'suspended', 'deleted']);
export const industryTypeEnum = pgEnum('industry_type', ['auto_detail', 'lawn_care', 'pet_grooming', 'house_cleaning', 'hvac', 'custom']);

export const tenants = pgTable('tenants', {
  id: uuid('id').primaryKey().defaultRandom(),
  slug: varchar('slug', { length: 100 }).notNull().unique(),
  name: varchar('name', { length: 255 }).notNull(),
  brandName: varchar('brand_name', { length: 255 }).notNull(),
  customDomain: varchar('custom_domain', { length: 255 }).unique(),
  industryType: industryTypeEnum('industry_type').notNull().default('custom'),
  status: tenantStatusEnum('status').notNull().default('pending'),
  timezone: varchar('timezone', { length: 50 }).notNull().default('America/Chicago'),
  
  logoUrl: text('logo_url'),
  primaryColor: varchar('primary_color', { length: 7 }).default('#3B82F6'),
  secondaryColor: varchar('secondary_color', { length: 7 }).default('#8B5CF6'),
  
  email: varchar('email', { length: 255 }),
  phone: varchar('phone', { length: 20 }),
  address: text('address'),
  
  onboardingStep: varchar('onboarding_step', { length: 50 }).default('business_basics'),
  onboardingCompleted: boolean('onboarding_completed').default(false),
  onboardingProgress: jsonb('onboarding_progress').$type<{
    business_basics: boolean;
    industry_pack: boolean;
    twilio: boolean;
    a2p: boolean;
    google: boolean;
    stripe: boolean;
    openai: boolean;
    sendgrid: boolean;
    preflight: boolean;
  }>(),
  
  createdAt: timestamp('created_at').defaultNow(),
  updatedAt: timestamp('updated_at').defaultNow(),
  goLiveAt: timestamp('go_live_at'),
  lastActiveAt: timestamp('last_active_at'),
});

// Update existing tables to include tenant_id
export const customers = pgTable('customers', {
  id: serial('id').primaryKey(),
  tenantId: uuid('tenant_id').notNull().references(() => tenants.id, { onDelete: 'cascade' }),
  name: text('name').notNull(),
  phone: text('phone').notNull(),
  // ... rest of fields
}, (table) => ({
  uniqueTenantPhone: unique().on(table.tenantId, table.phone),
}));

// Repeat for all tables...
```

---

## 3) Monorepo Structure

### 3.1 Simplified Structure (Replit-Compatible)

Since we're in Replit, keep a **simpler structure** that doesn't require complex tooling:

```
servicepro-monorepo/
├── server/
│   ├── index.ts (main Express app)
│   ├── routes/
│   │   ├── onboarding/          # NEW: Onboarding wizard endpoints
│   │   │   ├── step1-business.ts
│   │   │   ├── step2-industry.ts
│   │   │   ├── step3-twilio.ts
│   │   │   ├── step4-a2p.ts
│   │   │   ├── step5-google.ts
│   │   │   ├── step6-stripe.ts
│   │   │   ├── step7-openai.ts
│   │   │   ├── step8-sendgrid.ts
│   │   │   └── step9-preflight.ts
│   │   ├── widget/               # NEW: Widget public API
│   │   ├── validator/            # NEW: Landing page validator
│   │   ├── docs/                 # NEW: Docs CMS
│   │   └── ... existing routes
│   ├── middleware/
│   │   ├── tenant-resolution.ts  # NEW
│   │   ├── tenant-isolation.ts   # NEW
│   │   └── widget-auth.ts        # NEW
│   ├── services/
│   │   ├── secrets-vault.ts      # NEW
│   │   ├── feature-flags.ts      # NEW
│   │   ├── a2p-helper.ts         # NEW
│   │   └── ... existing services
│   ├── core/                     # NEW: Business logic (ports/adapters)
│   │   ├── scheduling/
│   │   ├── telephony/
│   │   ├── weather/
│   │   ├── billing/
│   │   └── ... (migrated from existing services)
│   └── ... existing files
├── client/
│   ├── src/
│   │   ├── pages/
│   │   │   ├── onboarding/       # NEW: Wizard pages
│   │   │   └── ... existing pages
│   │   └── ... existing structure
├── db/
│   ├── schema/
│   │   ├── tenants.ts            # NEW
│   │   ├── tenant-settings.ts    # NEW
│   │   ├── industry-packs.ts     # NEW
│   │   └── ... existing schemas (updated with tenant_id)
│   ├── migrations/
│   │   ├── 0001_create_tenants.sql
│   │   ├── 0002_add_tenant_settings.sql
│   │   └── ...
│   └── seeds/
│       └── root-tenant.ts
├── shared/                       # NEW: Types shared between client/server
│   └── types.ts
└── ... existing files
```

### 3.2 Why Not Full Monorepo Tooling?

- **Replit Constraints**: Turborepo/Nx add complexity in Replit environment
- **Single Deploy**: Everything builds and deploys together anyway
- **Simpler**: Easier to debug and iterate quickly

---

## 4) Secrets Vault Implementation

### 4.1 AWS Secrets Manager Client

```typescript
// server/services/secrets-vault.ts
import {
  SecretsManagerClient,
  GetSecretValueCommand,
  PutSecretValueCommand,
  CreateSecretCommand,
} from '@aws-sdk/client-secrets-manager';
import crypto from 'crypto';

const ALGORITHM = 'aes-256-gcm';
const MASTER_KEY = process.env.MASTER_ENCRYPTION_KEY!; // 32-byte hex string
const KEY_VERSION = parseInt(process.env.KEY_VERSION || '1');

class EncryptionService {
  private masterKey: Buffer;

  constructor() {
    if (!MASTER_KEY || MASTER_KEY.length !== 64) {
      throw new Error('MASTER_ENCRYPTION_KEY must be 64 hex characters (32 bytes)');
    }
    this.masterKey = Buffer.from(MASTER_KEY, 'hex');
  }

  encrypt(plaintext: string): { ciphertext: string; iv: string; authTag: string; keyVersion: number } {
    const iv = crypto.randomBytes(16);
    const cipher = crypto.createCipheriv(ALGORITHM, this.masterKey, iv);
    
    let ciphertext = cipher.update(plaintext, 'utf8', 'hex');
    ciphertext += cipher.final('hex');
    const authTag = cipher.getAuthTag();

    return {
      ciphertext,
      iv: iv.toString('hex'),
      authTag: authTag.toString('hex'),
      keyVersion: KEY_VERSION,
    };
  }

  decrypt(encrypted: { ciphertext: string; iv: string; authTag: string }): string {
    const decipher = crypto.createDecipheriv(
      ALGORITHM,
      this.masterKey,
      Buffer.from(encrypted.iv, 'hex')
    );
    decipher.setAuthTag(Buffer.from(encrypte