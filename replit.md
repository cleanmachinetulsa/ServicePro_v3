# Clean Machine Auto Detail / ServicePro Platform

## Overview
ServicePro is a multi-tenant, white-label SaaS platform designed to transform service businesses into AI-powered web applications. It provides comprehensive management for customers, appointments, loyalty programs, and payments, with integrated multi-channel communication (SMS, web chat, email, Facebook Messenger, Instagram DMs). The platform leverages AI (OpenAI) and Google Workspace APIs to automate tasks, enhance efficiency, and improve customer engagement. The strategic vision is to become "The Shopify of service businesses" for the service industry.

## User Preferences
- Preferred communication style: Simple, everyday language
- AI Agent Behavior: Keep customer conversations focused on auto detailing topics and services. Steer discussions away from irrelevant topics back to Clean Machine Auto Detail services, scheduling, and business-related inquiries.

## System Architecture

### UI/UX Decisions
The application features a modern, mobile-responsive 3-column layout built with shadcn/ui, incorporating a hexagonal shield logo, visual channel indicators, and gradient backgrounds. It includes PWA enhancements for branded install prompts, app shortcuts, badge notifications, and offline mode. The public website employs a glassmorphism design with gradients, animations, mobile responsiveness, and dynamic SEO components.

### Technical Implementations

**SMS Booking Confirmation System**: Bookings scheduled >= 14 days in the future automatically trigger a confirmation workflow. The `smsBookingRecords` table tracks confirmation status with the following flow: (1) When a booking is created via `handleBook()`, if the appointment is >= 14 days out, a record is created with `needsConfirmation=true`. (2) The `bookingConfirmationMonitor` cron job runs hourly (when `PLATFORM_BG_JOBS_ENABLED=1`) to send reminders at 7 days before and 48 hours before the appointment. (3) Customers respond with "CONFIRM" or "RESCHEDULE" SMS commands - these are intercepted BEFORE the LLM in `twilioTestSms.ts` and routed to `smsBookingRecordService.ts` for confirmation/rescheduling logic. (4) Unconfirmed bookings are auto-canceled 24 hours before the appointment, with calendar event deletion and customer notification. The system is fail-open: SMS booking record creation never blocks the main booking flow, and reminder failures are logged but non-blocking.

**Tenant Timezone System**: All appointment times are stored in UTC in the database. The `businessSettings.timezone` field (default: America/Chicago) controls customer-facing time display. The `server/timezoneUtils.ts` module provides `formatForSms()`, `formatForPush()`, and `setLocalTimeAndConvertToUtc()` utilities to ensure times display correctly in reminder SMS, push notifications, and booking confirmations.

The system supports production-ready message attachments with Google Drive, TCPA/CTIA-compliant SMS consent, and AI-powered features for damage assessment, scheduling, and message rephrasing using GPT-4o. Twilio Voice integration provides voicemail, missed call auto-SMS, and call logging. Security is enforced through Twilio webhook verification, E.164 normalization, request validation, and RBAC middleware. It features an iMessage-quality messaging suite with read receipts, typing indicators, reactions, and search. The platform includes service limits, maintenance mode, dynamic banner management, and auto-failover protection. A branded invoice email system offers professional, mobile-responsive invoices with upsell recommendations and HMAC-signed payment links. A centralized SMS template system allows dynamic editing with versioning and variable interpolation. Smart address validation with interactive map confirmation uses Google Maps. A comprehensive referral system with 9 reward types is implemented, including admin tools for code generation, tracking, and SMS invites. A dual phone line switching system supports two numbers with Google Voice-style UI and Twilio routing. A QR Code Security System with HMAC-SHA256 tokens is used for secure customer identification. Customer intelligence includes returning customer tracking and a GPT personalization service. Cash payment tracking includes manual entry and daily deposit widgets. A customizable dashboard system with drag-and-drop widgets is implemented for personalized user layouts. The platform also includes a Phone History Import Engine, Migration Wizard, and Parser Tool Hook for importing customer data, conversations, and messages. A usage and billing foundation provides visibility into current usage against plan limits for both tenant owners and root admins, with a tenant-facing page for Stripe integration, automated dunning, and server-side proxy for secure voicemail playback. A Simple vs Advanced UI Mode system provides per-user interface complexity preferences with a visible toggle. A comprehensive usage metering system records all billable events (SMS, AI, email, voice) to a centralized ledger.

### Feature Specifications
Key features include multi-platform messaging (Facebook Messenger, Instagram DMs), real-time SMS delivery monitoring, and an AI-powered chatbot (GPT-4o) for conversational AI, intent detection, and service recommendations. Smart Availability L2 provides AI-driven multi-slot booking deep links with individual slot URLs and a "View All Available Times" calendar link, plus booking funnel analytics tracking (link_clicked, page_viewed, form_started, booking_completed) in the `booking_initiation_events` table. Google Sheets Customer Import allows tenants to sync customer data with merge/dedup logic and dry-run preview via `/admin/customer-sheets-import`. **Sheets Auto-Sync** (`server/services/sheetsCustomerAutoSyncService.ts`) runs a cron job every 15 minutes (when `ENABLE_SHEETS_CUSTOMER_AUTO_SYNC=1`) to automatically sync customers from Google Sheets, using the idempotent findOrCreateCustomer pattern. A quote-first workflow for specialty jobs uses AI for keyword detection. A loyalty program with referral rewards, appointment scheduling with weather checking and conflict detection, an upselling system with context-aware offers, and email marketing capabilities are integrated. Real-time chat monitoring allows for manual takeover. Technicians can update job status to 'on_site' with automatic customer SMS notifications. The platform supports plan tiers (free/starter/pro/elite/internal) with feature gating for 12 features. The system also includes advanced conversation management with AI-powered handback analysis and smart scheduling extraction, a weather risk assessment system for appointments, a multi-tenant loyalty bonus campaign system, and an AI agent system aware of these campaigns. A complete SaaS pricing and tier comparison system includes a premium public /pricing page with glassmorphism UI, in-app upgrade modals, and locked feature components. A dual suggestion system enables tenant owners to submit platform feedback and customers to submit suggestions to their tenant's business. Square Gift Card Integration (SP-GIFTCARD-1) allows tenants to sync gift cards from their Square POS, view/manage them in an admin dashboard at `/settings/gift-cards`, and enables customers to apply gift cards during checkout via the reusable GiftCardApply component. The platform also supports custom domain routing, with specific redirection logic for `cleanmachinetulsa.com`, and includes HTTPS and www-to-root canonical redirects. Multi-tenant custom domain management is foundational for future use. The platform also includes an add-ons system to extend base plans with optional paid features and a demo mode system for a safe sandbox environment. A comprehensive usage metering system (v2) tracks usage with tier-based caps and cost estimates. An AI-powered parser integration analyzes phone history for onboarding knowledge extraction. SP-26 Usage Transparency v2 provides per-channel cost breakdown (SMS, MMS, Voice, Email, AI) with exact inbound/outbound rate calculations stored in `usage_rollups_daily`, accessible via tenant and root admin dashboards, and integrated with billing. SP-REWARDS-CAMPAIGN-TOKENS enables personalized rewards token links in SMS recovery campaigns using `{{rewardsLink}}` or `{rewards_link}` template variables; tokens are generated per-customer using HMAC-signed URLs with 30-day expiry, auto-appended if missing from template, and routed to tenant's verified custom domain or fallback URL. The Points Welcome Landing page includes a secondary "Browse services & pricing" CTA for improved user flow.

### System Design Choices
The architecture employs a React with TypeScript frontend (Vite, Tailwind CSS, shadcn/ui, TanStack React Query, React Hook Form with Zod, Stripe) and an Express.js backend with TypeScript. Core patterns include a monolithic service layer, multi-channel response formatting for AI, a customer memory system, and Google Sheets integration as a dynamic knowledge base. Data is stored in PostgreSQL (Neon serverless) with Drizzle ORM, Google Sheets, and Google Drive. Authentication is session-based. The Express server uses `app.set('trust proxy', true)` for correct handling of Replit's multi-layer proxy infrastructure.

## External Dependencies

**Google Workspace Suite**:
- **Google Calendar API**: Appointment scheduling and availability.
- **Google Sheets API**: Customer database and knowledge base.
- **Google Drive API**: Customer photo management.
- **Google Maps API**: Geocoding, distance/drive time calculation.

**Payment Processing**:
- **Stripe**: Primary payment gateway for payment intents, customer/subscription management.
- **PayPal**: Alternative payment option.
- **Square**: Gift card management - sync, validate, and redeem gift cards from Square POS.

**Communication Services**:
- **Twilio**: SMS notifications, voicemail transcription, and voice/IVR services.
- **SendGrid**: Email delivery.
- **Slack**: Internal business notifications and alerts.
- **Facebook Graph API**: Integration with Facebook Messenger and Instagram Direct Messages.

**Weather & Location**:
- **Open-Meteo API**: Free weather forecasting.

**AI & ML**:
- **OpenAI API**: GPT-4o for chatbot intelligence, conversational AI, intent detection, email content generation, service recommendations, and the Support AI Assistant.